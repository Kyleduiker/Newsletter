<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Newsletter Builder Pro - Enhanced Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Montserrat:wght@300;400;500;600&family=Crimson+Text:wght@400;600&family=Raleway:wght@300;400;500&family=Lora:wght@400;500&family=Cormorant+Garamond:wght@300;400;500&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-color: #EA102A;
            --primary-dark: #D10E26;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ff9800;
            --info-color: #2196f3;
            --border-color: #e0e0e0;
            --background-light: #f9f9f9;
            --text-dark: #333;
            --text-light: #666;
            --border-radius: 6px;
            --box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background: var(--background-light);
            color: var(--text-dark);
            min-height: 100vh;
            line-height: 1.5;
        }

        .skip-link {
            position: absolute;
            top: -40px;
            left: 6px;
            background: var(--primary-color);
            color: white;
            padding: 8px;
            text-decoration: none;
            border-radius: 0 0 4px 4px;
            z-index: 10000;
        }

        .skip-link:focus {
            top: 0;
        }

        .dashboard-container {
            display: grid;
            grid-template-columns: 450px 1fr;
            min-height: 100vh;
        }
        
        .sidebar {
            background: white;
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            box-shadow: 2px 0 15px rgba(0,0,0,0.08);
        }
        
        .preview-container {
            background: var(--background-light);
            padding: 20px;
            overflow-y: auto;
        }

        .app-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 30px 25px;
            text-align: center;
        }
        
        .app-header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 26px;
            font-weight: 400;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }
        
        .app-header .subtitle {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 20px;
        }
        
        .app-header .edition-badge {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 5px;
            font-size: 12px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .form-content {
            padding: 30px 25px;
        }
        
        .form-section {
            margin-bottom: 35px;
            border: 1px solid #f0f0f0;
            border-radius: 8px;
            padding: 25px;
            background: #fafafa;
        }
        
        .form-section__header {
            color: var(--text-dark);
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-section__header::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--primary-color);
            border-radius: 2px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group__label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-light);
            font-size: 13px;
        }
        
        .form-group__input,
        .form-group__textarea,
        .form-group__select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 14px;
            font-family: 'Montserrat', sans-serif;
            transition: var(--transition);
            background: white;
            min-height: 44px;
        }

        .form-group__input[type="file"] {
            padding: 8px 15px;
            cursor: pointer;
        }
        
        .form-group__input[type="file"]::-webkit-file-upload-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            margin-right: 10px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .form-group__input:focus,
        .form-group__textarea:focus,
        .form-group__select:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(234, 16, 42, 0.1);
            transform: translateY(-1px);
        }

        .form-group__input.invalid,
        .form-group__textarea.invalid,
        .form-group__select.invalid {
            border-color: var(--danger-color);
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
        }

        .form-group__input.valid,
        .form-group__textarea.valid,
        .form-group__select.valid {
            border-color: var(--success-color);
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
        }

        .validation-message {
            font-size: 12px;
            margin-top: 5px;
            display: none;
            line-height: 1.4;
        }

        .validation-message.error {
            color: var(--danger-color);
            display: block;
        }

        .validation-message.success {
            color: var(--success-color);
            display: block;
        }

        .required-field::after {
            content: ' *';
            color: var(--danger-color);
            font-weight: bold;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            background: white;
            border: 2px solid #f0f0f0;
            border-radius: var(--border-radius);
            padding: 12px 15px;
            transition: var(--transition);
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 44px;
        }
        
        .stat-item:focus-within {
            border-color: var(--primary-color);
        }
        
        .stat-item__label {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-light);
            font-weight: 600;
            letter-spacing: 0.5px;
            margin: 0;
            flex: 1;
        }
        
        .stat-item__input {
            border: none;
            padding: 0;
            font-size: 15px;
            font-weight: 600;
            color: var(--primary-color);
            background: transparent;
            text-align: right;
            width: 100px;
            flex-shrink: 0;
        }

        .stat-item__input:focus {
            outline: 1px solid var(--primary-color);
            border-radius: 4px;
            padding: 4px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 13px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            min-height: 44px;
            justify-content: center;
        }

        .btn:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }
        
        .btn--primary {
            background: var(--primary-color);
            color: white;
        }
        
        .btn--primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(234, 16, 42, 0.3);
        }
        
        .btn--secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn--success {
            background: var(--success-color);
            color: white;
        }

        .btn--info {
            background: var(--info-color);
            color: white;
        }

        .btn--info:hover {
            background: #1976d2;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
        }
        
        .btn--full {
            width: 100%;
            justify-content: center;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        
        .modal-overlay--show {
            display: flex;
        }
        
        .modal {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .toast {
            min-width: 300px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            box-shadow: var(--box-shadow);
            animation: slideIn 0.3s ease-out;
            position: relative;
            overflow: hidden;
        }
        
        .toast--success { background: var(--success-color); }
        .toast--error { background: var(--danger-color); }
        .toast--warning { background: var(--warning-color); }
        .toast--info { background: var(--info-color); }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .preview-header {
            background: white;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: var(--box-shadow);
        }
        
        .preview-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .newsletter-preview {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--box-shadow);
            max-width: 700px;
            margin: 0 auto;
        }

        .event-item {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
        }
        
        .event-delete {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 44px;
            min-height: 44px;
        }

        .image-preview {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .compatibility-warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid #ff9800;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .compatibility-warning h4 {
            color: #856404;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .compatibility-warning ul {
            color: #856404;
            margin: 0;
            padding-left: 20px;
        }

        .compatibility-info {
            background: #d1ecf1;
            border: 2px solid #17a2b8;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .compatibility-info h4 {
            color: #0c5460;
            margin-bottom: 10px;
        }

        .compatibility-info div {
            font-size: 13px;
            color: #0c5460;
            line-height: 1.4;
        }

        @media (max-width: 1023px) {
            .dashboard-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }
            
            .sidebar {
                max-height: 60vh;
                overflow-y: auto;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                position: sticky;
                top: 0;
                z-index: 100;
            }
            
            .form-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }

        @media (max-width: 767px) {
            .app-header {
                padding: 20px 15px;
            }
            
            .app-header h1 {
                font-size: 22px;
                margin-bottom: 8px;
            }
            
            .form-content {
                padding: 20px 15px;
            }
            
            .form-section {
                padding: 15px;
                margin-bottom: 20px;
            }
            
            .stat-item {
                flex-direction: column;
                text-align: center;
                gap: 8px;
            }
            
            .stat-item__input {
                width: 100%;
                text-align: center;
                font-size: 16px;
                border: 1px solid #ddd;
                border-radius: 4px;
                padding: 8px;
            }
            
            .preview-actions {
                flex-direction: column;
                gap: 10px;
            }
            
            .preview-actions .btn {
                width: 100%;
            }
        }

        @media print {
            .sidebar,
            .preview-header,
            .preview-actions,
            .toast-container,
            .modal-overlay {
                display: none !important;
            }
            
            .dashboard-container {
                grid-template-columns: 1fr;
                min-height: auto;
            }
            
            .preview-container {
                padding: 0;
                background: white;
            }
            
            .newsletter-preview {
                box-shadow: none;
                margin: 0;
                max-width: none;
                width: 100%;
                background: white;
                border-radius: 0;
                overflow: visible;
            }
            
            @page {
                margin: 0.75in;
                size: letter;
            }
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Export Modal -->
    <div class="modal-overlay" id="exportModal">
        <div class="modal">
            <h3 style="margin-bottom: 20px; font-size: 20px;">📧 Export Newsletter</h3>
            
            <div class="compatibility-warning">
                <h4>✅ Email Client Compatibility</h4>
                <ul style="margin: 10px 0; font-size: 13px; line-height: 1.4;">
                    <li>All images are automatically uploaded to Imgur for perfect email compatibility</li>
                    <li>Newsletter uses hosted image URLs - works in all email clients</li>
                    <li>No blocked images or deliverability issues</li>
                    <li>Always test in your target email clients before sending</li>
                    <li>Professional hosting ensures images load reliably</li>
                </ul>
            </div>
            
            <div class="compatibility-info">
                <h4>📊 Email Client Support</h4>
                <div>
                    ✅ <strong>Gmail:</strong> Excellent support<br>
                    ✅ <strong>Apple Mail:</strong> Best support<br>
                    ⚠️ <strong>Outlook:</strong> Limited styling<br>
                    ⚠️ <strong>Yahoo:</strong> Basic features only
                </div>
            </div>

            <div class="compatibility-info">
                <h4>🖨️ Print Optimization</h4>
                <div>
                    <strong>Print Version:</strong> Optimized for standard letter paper (8.5" x 11")<br>
                    <strong>Features:</strong> Proper margins, page breaks, black & white friendly<br>
                    <strong>Best For:</strong> Client handouts, office distribution, archival copies
                </div>
            </div>
            
            <div style="display: grid; gap: 10px; margin-top: 20px;">
                <button class="btn btn--primary" onclick="exportManager.copyEmailSafeHTML()">
                    📧 Copy Email-Safe HTML (Hosted URLs)
                </button>
                <button class="btn btn--success" onclick="exportManager.exportAsHTML()">
                    📄 Download HTML File (Hosted URLs)
                </button>
                <button class="btn btn--info" onclick="exportManager.printNewsletter()">
                    🖨️ Print Newsletter
                </button>
                <button class="btn btn--secondary" onclick="modalManager.close('exportModal')">
                    Cancel
                </button>
            </div>
        </div>
    </div>
    
    <!-- Add Event Modal -->
    <div class="modal-overlay" id="addEventModal">
        <div class="modal">
            <h3 style="margin-bottom: 20px;">Add Event</h3>
            <form id="addEventForm">
                <div class="form-group">
                    <label class="form-group__label required-field">Event Title</label>
                    <input type="text" class="form-group__input" id="eventTitle" required>
                    <div class="validation-message" id="eventTitle-validation"></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-group__label required-field">Date</label>
                        <input type="date" class="form-group__input" id="eventDate" required>
                        <div class="validation-message" id="eventDate-validation"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-group__label">Start Time</label>
                        <input type="time" class="form-group__input" id="eventStartTime">
                        <div class="validation-message" id="eventStartTime-validation"></div>
                        <small style="color: #666; font-size: 11px;">Optional - leave blank for all-day events</small>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-group__label">End Time</label>
                    <input type="time" class="form-group__input" id="eventEndTime">
                    <div class="validation-message" id="eventEndTime-validation"></div>
                    <small style="color: #666; font-size: 11px;">Optional - leave blank if no specific end time</small>
                </div>
                <div class="form-group">
                    <label class="form-group__label">Location</label>
                    <input type="text" class="form-group__input" id="eventLocation">
                    <div class="validation-message" id="eventLocation-validation"></div>
                    <small style="color: #666; font-size: 11px;">Optional - leave blank for online events or TBA</small>
                </div>
                <div class="form-group">
                    <label class="form-group__label">Description (Optional)</label>
                    <textarea class="form-group__textarea" id="eventDescription" rows="3"></textarea>
                    <div class="validation-message" id="eventDescription-validation"></div>
                </div>
                <div class="form-group">
                    <label class="form-group__label">Event Details Link (Optional)</label>
                    <input type="url" class="form-group__input" id="eventDetailsLink" placeholder="https://example.com/event-details">
                    <div class="validation-message" id="eventDetailsLink-validation"></div>
                    <small style="color: #666; font-size: 11px;">Optional - link to registration page, more details, or event website</small>
                </div>
                <div class="form-group">
                    <label class="form-group__label">Event Image (Optional)</label>
                    <input type="file" class="form-group__input" id="eventImage" accept="image/*" onchange="handleEventImageUpload()">
                    <div class="image-preview" id="eventImagePreview" style="margin-top: 10px; display: none;">
                        <img style="width: 120px; height: 80px; object-fit: cover; border-radius: 4px; border: 2px solid #ddd;">
                        <button type="button" onclick="removeEventImage()" style="margin-left: 10px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">Remove</button>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn--primary" style="flex: 1;">Add Event</button>
                    <button type="button" class="btn btn--secondary" onclick="modalManager.close('addEventModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <main id="main-content" class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="app-header">
                <h1>Newsletter Builder Pro</h1>
                <p class="subtitle">Enhanced Real Estate Marketing</p>
                <div class="edition-badge">
                    <strong id="currentMonth">June 2025 Edition</strong><br>
                    <small>🚀 Production Ready</small>
                </div>
            </div>
            
            <div class="form-content">
                <!-- Month Selection -->
                <div class="form-section">
                    <h3 class="form-section__header">📅 Month & Theme</h3>
                    <div class="form-group">
                        <label class="form-group__label">Newsletter Month</label>
                        <select class="form-group__select" id="newsletterSeason">
                            <option value="january">January - New Beginnings</option>
                            <option value="february">February - Love Your Home</option>
                            <option value="march">March - Spring Prep</option>
                            <option value="april">April - Spring Awakening</option>
                            <option value="may">May - Blooming Season</option>
                            <option value="june" selected>June - Summer Starts</option>
                            <option value="july">July - Summer Living</option>
                            <option value="august">August - Late Summer</option>
                            <option value="september">September - Fall Prep</option>
                            <option value="october">October - Autumn Comfort</option>
                            <option value="november">November - Thanksgiving Season</option>
                            <option value="december">December - Holiday Season</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-group__label">Custom Subtitle</label>
                        <input type="text" class="form-group__input" id="customSubtitle" value="SUMMER STARTS" placeholder="Enter custom subtitle...">
                        <div class="validation-message" id="customSubtitle-validation"></div>
                        <small style="color: #666; font-size: 11px;">Leave blank to use default seasonal subtitle</small>
                    </div>
                </div>
                
                <!-- Banner Design -->
                <div class="form-section">
                    <h3 class="form-section__header">🎨 Banner Design</h3>
                    <div class="form-group">
                        <label class="form-group__label">Banner Style</label>
                        <select class="form-group__select" id="bannerStyle">
                            <option value="mountains" selected>Mountains</option>
                            <option value="cityscape">City Skyline</option>
                            <option value="blueprint">Blueprint</option>
                            <option value="minimal">Clean Minimal</option>
                            <option value="custom">Custom Banner Image</option>
                            <option value="none">No Banner</option>
                        </select>
                    </div>
                    
                    <!-- Custom Banner Upload (only shows when custom is selected) -->
                    <div class="form-group" id="customBannerUpload" style="display: none;">
                        <label class="form-group__label">Custom Banner Image</label>
                        <input type="file" class="form-group__input" id="customBanner" accept="image/*" onchange="handleImageUpload('customBanner', 'customBanner')">
                        <div class="image-preview" id="customBannerPreview" style="margin-top: 10px; display: none;">
                            <img style="width: 200px; height: 100px; object-fit: cover; border: 2px solid #ddd; border-radius: 4px;">
                            <button type="button" onclick="removeImage('customBanner', 'customBanner')" style="margin-left: 10px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">Remove</button>
                        </div>
                        <small style="color: #666; font-size: 11px; display: block; margin-top: 5px;">
                            📏 Recommended size: 600x300px or similar landscape ratio for custom banners
                        </small>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-group__label">Header Font</label>
                            <select class="form-group__select" id="headerFont">
                                <option value="'Playfair Display', serif" selected>Playfair Display</option>
                                <option value="'Cormorant Garamond', serif">Cormorant Garamond</option>
                                <option value="'Lora', serif">Lora</option>
                                <option value="'Crimson Text', serif">Crimson Text</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-group__label">Body Font</label>
                            <select class="form-group__select" id="bodyFont">
                                <option value="'Montserrat', sans-serif" selected>Montserrat</option>
                                <option value="'Raleway', sans-serif">Raleway</option>
                                <option value="'Helvetica Neue', sans-serif">Helvetica Neue</option>
                                <option value="Arial, sans-serif">Arial</option>
                            </select>
                        </div>
                    </div>
                    

                </div>
                
                <!-- Personal Message -->
                <div class="form-section">
                    <h3 class="form-section__header">💬 Personal Message</h3>
                    <div class="form-group">
                        <label class="form-group__label required-field">Opening Message</label>
                        <textarea class="form-group__textarea" id="personalMessage" rows="4" required>With school winding down and the sun heating up, June is a top month for real estate. Let's make your next move a smooth one.</textarea>
                        <div class="validation-message" id="personalMessage-validation"></div>
                        <small style="color: #666; font-size: 11px;">Minimum 50 characters, maximum 500 characters</small>
                    </div>
                </div>
                
                <!-- Market Statistics -->
                <div class="form-section">
                    <h3 class="form-section__header">📊 Market Statistics</h3>
                    <p style="font-size: 12px; color: #666; margin-bottom: 20px;">
                        Enter your market statistics manually. The system will organize them into a professional layout.
                    </p>
                    
                    <div class="stats-grid" id="statsGrid">
                        <!-- Stats will be rendered here -->
                    </div>
                    
                    <hr style="border: none; border-top: 1px solid #e0e0e0; margin: 20px 0;">
                    <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
                        📄 Optional call-to-action button after market analysis
                    </p>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-group__label">Button Text (Optional)</label>
                            <input type="text" class="form-group__input" id="marketButtonText" value="View Full Market Report" placeholder="View Full Market Report">
                            <div class="validation-message" id="marketButtonText-validation"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-group__label">Button URL (Optional)</label>
                            <input type="url" class="form-group__input" id="marketButtonUrl" value="https://www.example.com/market-report" placeholder="https://example.com/market-report">
                            <div class="validation-message" id="marketButtonUrl-validation"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Community Calendar & Events -->
                <div class="form-section">
                    <h3 class="form-section__header">📅 Community Calendar & Events</h3>
                    <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
                        Add your community events with optional images automatically hosted on Imgur for email compatibility. Only Title and Date are required. Add details links for registration pages, more info, or event websites.
                    </p>
                    <button type="button" class="btn btn--primary btn--full" onclick="modalManager.show('addEventModal')">
                        + Add Event
                    </button>
                    <div id="customEventsList" style="margin-top: 15px;">
                        <!-- Custom events will appear here -->
                    </div>
                </div>
                
                <!-- Maintenance Tips -->
                <div class="form-section">
                    <h3 class="form-section__header">🔧 Maintenance Tips</h3>
                    <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
                        Seasonal maintenance tips are automatically included based on your selected month. You can customize them here if needed.
                    </p>
                    <div class="form-group">
                        <label class="form-group__label">Custom Maintenance Tips (Optional)</label>
                        <textarea class="form-group__textarea" id="customMaintenanceTips" rows="4" placeholder="Add your own maintenance tips, one per line. Leave blank to use default seasonal tips."></textarea>
                        <div class="validation-message" id="customMaintenanceTips-validation"></div>
                        <small style="color: #666; font-size: 11px;">Enter custom tips separated by new lines, or leave blank to use seasonal defaults</small>
                    </div>
                </div>
                
                <!-- Your Information -->
                <div class="form-section">
                    <h3 class="form-section__header">👤 Your Information</h3>
                    <div class="form-group">
                        <label class="form-group__label required-field">Full Name</label>
                        <input type="text" class="form-group__input" id="agentName" value="Kyle Duiker" required>
                        <div class="validation-message" id="agentName-validation"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-group__label required-field">Company Name</label>
                        <input type="text" class="form-group__input" id="companyName" value="Royal LePage" required>
                        <div class="validation-message" id="companyName-validation"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-group__label required-field">Phone</label>
                            <input type="tel" class="form-group__input" id="agentPhone" value="(403) 123-4567" required>
                            <div class="validation-message" id="agentPhone-validation"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-group__label required-field">Email</label>
                            <input type="email" class="form-group__input" id="agentEmail" value="kyle@royallepage.ca" required>
                            <div class="validation-message" id="agentEmail-validation"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-group__label required-field">Website</label>
                        <input type="url" class="form-group__input" id="agentWebsite" value="www.realestatecalgary.com" required>
                        <div class="validation-message" id="agentWebsite-validation"></div>
                    </div>
                    
                    <hr style="border: none; border-top: 1px solid #e0e0e0; margin: 20px 0;">
                    <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
                        📷 Upload your professional photos and logos (automatically hosted on Imgur)
                    </p>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-group__label">Agent Photo</label>
                            <input type="file" class="form-group__input" id="agentPhoto" accept="image/*" onchange="handleImageUpload('agentPhoto', 'agentPhoto')">
                            <div class="image-preview" id="agentPhotoPreview" style="margin-top: 10px; display: none;">
                                <img style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid #ddd;">
                                <button type="button" onclick="removeImage('agentPhoto', 'agentPhoto')" style="margin-left: 10px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">Remove</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-group__label">Agent Logo</label>
                            <input type="file" class="form-group__input" id="agentLogo" accept="image/*" onchange="handleImageUpload('agentLogo', 'agentLogo')">
                            <div class="image-preview" id="agentLogoPreview" style="margin-top: 10px; display: none;">
                                <img style="width: 80px; height: 60px; object-fit: contain; border: 2px solid #ddd; border-radius: 4px;">
                                <button type="button" onclick="removeImage('agentLogo', 'agentLogo')" style="margin-left: 10px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">Remove</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-group__label">Brokerage Logo</label>
                        <input type="file" class="form-group__input" id="brokerageLogo" accept="image/*" onchange="handleImageUpload('brokerageLogo', 'brokerageLogo')">
                        <div class="image-preview" id="brokerageLogoPreview" style="margin-top: 10px; display: none;">
                            <img style="width: 120px; height: 60px; object-fit: contain; border: 2px solid #ddd; border-radius: 4px;">
                            <button type="button" onclick="removeImage('brokerageLogo', 'brokerageLogo')" style="margin-left: 10px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">Remove</button>
                        </div>
                    </div>
                    
                    <hr style="border: none; border-top: 1px solid #e0e0e0; margin: 20px 0;">
                    <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
                        🔗 Action buttons that appear below your personal message
                    </p>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-group__label">Buyers Guide URL</label>
                            <input type="url" class="form-group__input" id="buyersGuideUrl" value="https://www.realestatecalgary.com/buyers-guide" placeholder="https://example.com/buyers-guide">
                            <div class="validation-message" id="buyersGuideUrl-validation"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-group__label">Sellers Guide URL</label>
                            <input type="url" class="form-group__input" id="sellersGuideUrl" value="https://www.realestatecalgary.com/sellers-guide" placeholder="https://example.com/sellers-guide">
                            <div class="validation-message" id="sellersGuideUrl-validation"></div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-group__label">My Website URL</label>
                            <input type="url" class="form-group__input" id="myWebsiteUrl" value="https://www.realestatecalgary.com" placeholder="https://example.com">
                            <div class="validation-message" id="myWebsiteUrl-validation"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-group__label">Blog URL</label>
                            <input type="url" class="form-group__input" id="blogUrl" value="https://www.realestatecalgary.com/blog" placeholder="https://example.com/blog">
                            <div class="validation-message" id="blogUrl-validation"></div>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn--primary btn--full" onclick="generateNewsletter()" style="font-size: 16px; padding: 16px 24px;">
                    ✨ Generate Newsletter
                </button>
            </div>
        </div>
        
        <!-- Preview Container -->
        <div class="preview-container">
            <div class="preview-header">
                <h2>Newsletter Preview</h2>
                <p>Email-ready newsletter with Imgur hosted images</p>
                
                <div class="preview-actions">
                    <button class="btn btn--secondary" onclick="toggleCode()">
                        👁️ View HTML
                    </button>
                    <button class="btn btn--primary" onclick="copyToClipboard()">
                        📋 Copy Code
                    </button>
                    <button class="btn btn--info" onclick="quickPrint()">
                        🖨️ Print
                    </button>
                    <button class="btn btn--success" onclick="modalManager.show('exportModal')">
                        📧 Export Options
                    </button>
                </div>
            </div>
            
            <div class="newsletter-preview" id="newsletterPreview">
                <!-- Newsletter content will be generated here -->
            </div>
            
            <div style="background: #2d3748; color: #e2e8f0; padding: 25px; border-radius: 8px; font-family: monospace; font-size: 12px; max-height: 500px; overflow-y: auto; white-space: pre-wrap; margin-top: 25px; display: none;" id="codeOutput"></div>
        </div>
    </main>

    <script>
        // Global state
        let newsletterData = {
            design: {
                bannerStyle: 'mountains',
                headerFont: "'Playfair Display', serif",
                bodyFont: "'Montserrat', sans-serif"
            },
            images: {
                currentEventImage: null,
                agentPhoto: null,
                agentLogo: null,
                brokerageLogo: null,
                customBanner: null
            },
            stats: {
                avgPrice: '$589,900',
                priceChange: '-2.5%',
                daysOnMarket: '79',
                homesSold: '2,568',
                salesChange: '-16.9%',
                newListings: '4,842',
                listingsChange: '+11.6%',
                inventory: '6,740',
                inventoryChange: '+97.5%',
                monthsOfSupply: '2.62',
                supplyChange: '+137.7%',
                
                // Property type breakdowns
                detachedPrice: '$769,400',
                detachedChange: '+1.0%',
                detachedSales: '1,275',
                detachedSalesChange: '-8%',
                detachedListings: '2,419',
                detachedListingsChange: '+19%',
                detachedInventory: '2,995',
                detachedInventoryChange: '+87%',
                detachedSupply: '2.35',
                
                semiPrice: '$697,300',
                semiChange: '+2.8%',
                semiSales: '256',
                semiSalesChange: '-1%',
                semiListings: '428',
                semiListingsChange: '+19%',
                semiInventory: '542',
                semiInventoryChange: '+99%',
                semiSupply: '2.12',
                
                rowPrice: '$453,600',
                rowChange: '-1.9%',
                rowSales: '458',
                rowSalesChange: '-15%',
                rowListings: '764',
                rowListingsChange: '+11%',
                rowInventory: '1,116',
                rowInventoryChange: '+161%',
                rowSupply: '2.44',
                
                apartmentPrice: '$335,300',
                apartmentChange: '-1.5%',
                apartmentSales: '579',
                apartmentSalesChange: '-36%',
                apartmentListings: '1,231',
                apartmentListingsChange: '-2%',
                apartmentInventory: '2,087',
                apartmentInventoryChange: '+88%',
                apartmentSupply: '3.60'
            },
            agent: {
                name: 'Kyle Duiker',
                company: 'Royal LePage',
                phone: '(403) 123-4567',
                email: 'kyle@royallepage.ca',
                website: 'www.realestatecalgary.com',
                buyersGuideUrl: 'https://www.realestatecalgary.com/buyers-guide',
                sellersGuideUrl: 'https://www.realestatecalgary.com/sellers-guide',
                myWebsiteUrl: 'https://www.realestatecalgary.com',
                blogUrl: 'https://www.realestatecalgary.com/blog'
            },
            content: {
                personalMessage: 'With school winding down and the sun heating up, June is a top month for real estate. Let\'s make your next move a smooth one.',
                newsletterSeason: 'june',
                customSubtitle: 'SUMMER STARTS',
                customMaintenanceTips: '',
                marketButtonText: 'View Full Market Report',
                marketButtonUrl: 'https://www.example.com/market-report'
            },
            customEvents: []
        };

        // Season configurations
        const SEASONS = {
            january: {
                title: 'JANUARY NEWSLETTER',
                subtitle: 'NEW BEGINNINGS',
                personalMessage: 'Happy New Year! A fresh start brings new opportunities—whether it\'s upgrading your space or buying your first home. Let\'s make 2025 the year of great moves!',
                tips: ['🔧 Replace furnace filter', '💧 Use humidifier to combat dry air', '🧊 Watch for ice dams after Chinooks', '❄️ Check for frost in attic/basement', '🚨 Test smoke & CO detectors']
            },
            february: {
                title: 'FEBRUARY NEWSLETTER',
                subtitle: 'LOVE YOUR HOME',
                personalMessage: 'Love is in the air—and so is opportunity! Whether you\'re buying, selling, or just curious, I\'m here to help you find a home you\'ll love.',
                tips: ['🌨️ Clear snow from foundation & vents', '🚪 Inspect weather stripping after freeze-thaw', '🔐 Lubricate locks & garage mechanisms', '💧 Monitor for condensation inside windows', '⚡ Test sump pump for early thaw']
            },
            march: {
                title: 'MARCH NEWSLETTER',
                subtitle: 'SPRING PREP',
                personalMessage: 'As the snow melts and days grow longer, now\'s the time to start thinking spring market. Real estate is warming up—are you ready?',
                tips: ['☀️ Begin clearing snow from perimeter', '💧 Check grading for pooling meltwater', '🏠 Book roof inspection before spring rain', '🌳 Trim snow-damaged tree limbs', '🌱 Prep garden tools & order supplies']
            },
            april: {
                title: 'APRIL NEWSLETTER',
                subtitle: 'SPRING AWAKENING',
                personalMessage: 'Spring is in full swing! It\'s a great time to freshen up your home or explore new listings. Let\'s talk about what\'s happening in your area.',
                tips: ['🌧️ Clean gutters/downspouts', '🏠 Inspect shingles & siding for winter damage', '💧 Test exterior taps (after final frost)', '🔧 Caulk windows and doors', '🌿 Fertilize lawn (spring mix)']
            },
            may: {
                title: 'MAY NEWSLETTER',
                subtitle: 'BLOOMING SEASON',
                personalMessage: 'May is for patios, gardening, and maybe even new beginnings. If you\'ve been thinking of a move, the spring market is buzzing!',
                tips: ['🚿 Power wash siding, deck, walkways', '💧 Inspect irrigation system for leaks', '🔧 Reseal driveway and deck surfaces', '🍖 Clean BBQ and prep outdoor living space', '🐛 Monitor for signs of pests and insects']
            },
            june: {
                title: 'JUNE NEWSLETTER',
                subtitle: 'SUMMER STARTS',
                personalMessage: 'With school winding down and the sun heating up, June is a top month for real estate. Let\'s make your next move a smooth one.',
                tips: ['❄️ Test A/C and change filters', '🌧️ Check eavestrough slope and extension', '🔧 Inspect fence posts for shifting', '🪟 Wash windows and inspect screens', '💨 Secure patio furniture before windstorms']
            },
            july: {
                title: 'JULY NEWSLETTER',
                subtitle: 'SUMMER LIVING',
                personalMessage: 'It\'s summer fun and sunshine! The market\'s still active, and I\'m here to help you take the next step—whether you\'re buying or selling.',
                tips: ['🌳 Trim trees near home (hail + wind risk)', '🏠 Check attic insulation and ventilation', '☀️ Use UV films or blinds on sunny windows', '💧 Water lawn early mornings (drought)', '🔥 Inspect dryer vent (fire safety)']
            },
            august: {
                title: 'AUGUST NEWSLETTER',
                subtitle: 'LATE SUMMER',
                personalMessage: 'Before fall routines kick in, August is the perfect time to make a move or prep your home for sale. Let\'s chat about your next step!',
                tips: ['🏠 Review roof for hail damage', '🔥 Prep furnace for fall (early servicing)', '🧹 Deep clean garage or shed', '📋 Plan fall landscaping or repairs', '🎨 Touch up exterior paint']
            },
            september: {
                title: 'SEPTEMBER NEWSLETTER',
                subtitle: 'FALL PREP',
                personalMessage: 'As routines return and leaves begin to turn, it\'s a great time to revisit your real estate goals. Fall can be full of opportunity!',
                tips: ['💧 Blow out sprinklers before frost', '🌿 Fertilize lawn (fall mix)', '🔥 Inspect chimney and fireplace', '📦 Store summer tools and patio gear', '🐭 Check attic and garage for rodent entry']
            },
            october: {
                title: 'OCTOBER NEWSLETTER',
                subtitle: 'AUTUMN COMFORT',
                personalMessage: 'Fall is here and so is one of the coziest times to shop for a new place. Let\'s talk listings, market trends, or your real estate wish list!',
                tips: ['❄️ Winterize outdoor faucets and hoses', '🍂 Rake and compost leaves', '🏠 Inspect foundation for cracks', '🔥 Test heating system and thermostat', '🚪 Apply weather seal to doors/windows']
            },
            november: {
                title: 'NOVEMBER NEWSLETTER',
                subtitle: 'THANKSGIVING SEASON',
                personalMessage: 'Before the holiday rush, November is a great time to review your plans. Thinking of a move in the new year? Let\'s get ahead of it together.',
                tips: ['❄️ Prepare snow removal equipment', '❄️ Cover or store A/C units', '💡 Install exterior light timers', '🧊 Stock ice melt and emergency supplies', '🔧 Replace furnace filter']
            },
            december: {
                title: 'DECEMBER NEWSLETTER',
                subtitle: 'HOLIDAY SEASON',
                personalMessage: 'Wishing you a warm and peaceful holiday season! Whether you\'re cozy at home or planning a change in the new year, I\'m here when you need me.',
                tips: ['❄️ Clear snow from roof edges and vents', '🚨 Test CO detectors during peak furnace use', '💨 Check for drafts around windows', '🚶 Keep exits and walkways snow-free', '🏠 Inspect roof load if heavy snowfalls occur']
            }
        };

        // Time formatting helper
        function formatEventTime(startTime, endTime) {
            if (!startTime) return '';
            
            // Convert 24-hour time to 12-hour format
            function formatTime(timeStr) {
                const [hours, minutes] = timeStr.split(':');
                const hour12 = hours % 12 || 12;
                const ampm = hours >= 12 ? 'PM' : 'AM';
                return `${hour12}:${minutes} ${ampm}`;
            }
            
            const formattedStart = formatTime(startTime);
            
            if (endTime) {
                const formattedEnd = formatTime(endTime);
                return `${formattedStart} - ${formattedEnd}`;
            }
            
            return formattedStart;
        }

        // Date formatting helper to avoid timezone issues
        function formatEventDate(dateString) {
            // Parse YYYY-MM-DD format directly to avoid timezone issues
            const [year, month, day] = dateString.split('-');
            const monthNames = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 
                               'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
            return {
                month: monthNames[parseInt(month) - 1],
                day: parseInt(day)
            };
        }

        // Imgur API integration - Your personal app
        const IMGUR_CLIENT_ID = '203a7e94de049ff'; // Your personal Imgur app
        
        async function uploadToImgur(file, imageKey) {
            const formData = new FormData();
            formData.append('image', file);
            
            try {
                showToast('📤 Uploading to Imgur...', 'info', 3000);
                
                const response = await fetch('https://api.imgur.com/3/image', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Client-ID ${IMGUR_CLIENT_ID}`
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const imgurUrl = data.data.link;
                    // Store only the Imgur URL
                    newsletterData.images[imageKey] = imgurUrl;
                    
                    showToast('✅ Image uploaded successfully!', 'success', 4000);
                    updatePreview(); // Update the newsletter preview
                    
                    return imgurUrl;
                } else {
                    throw new Error(data.data?.error || 'Upload failed');
                }
            } catch (error) {
                console.error('Imgur upload error:', error);
                showToast('❌ Upload failed. Please try again.', 'error', 5000);
                return null;
            }
        }

        // Image handling functions
        function handleImageUpload(inputId, imageKey) {
            const input = document.getElementById(inputId);
            const file = input.files[0];
            
            if (file) {
                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    showToast('❌ Image size must be less than 5MB', 'error');
                    input.value = '';
                    return;
                }
                
                // Show uploading status immediately
                showImagePreview(inputId, null, 'uploading');
                
                // Upload directly to Imgur
                uploadToImgur(file, imageKey).then(imgurUrl => {
                    if (imgurUrl) {
                        showImagePreview(inputId, imgurUrl, 'success');
                    } else {
                        // Upload failed, hide preview
                        document.getElementById(inputId + 'Preview').style.display = 'none';
                        input.value = '';
                    }
                });
            }
        }

        function showImagePreview(inputId, imageSrc, status = 'success') {
            const preview = document.getElementById(inputId + 'Preview');
            const img = preview.querySelector('img');
            
            if (status === 'uploading') {
                preview.style.display = 'block';
                img.style.opacity = '0.5';
                img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iNDAiIGN5PSI0MCIgcj0iMzAiIHN0cm9rZT0iI2RkZCIgc3Ryb2tlLXdpZHRoPSI0Ii8+Cjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSIgZm9udC1zaXplPSIxMiIgZmlsbD0iIzk5OSI+4oGq4oGq4oGq8J+TpDwvdGV4dD4KPC9zdmc+'; // Placeholder loading image
            } else if (status === 'success' && imageSrc) {
                img.style.opacity = '1';
                img.src = imageSrc;
                preview.style.display = 'block';
            }
            
            // Update status indicator
            const statusDiv = preview.querySelector('.upload-status') || document.createElement('div');
            statusDiv.className = 'upload-status';
            statusDiv.style.cssText = 'font-size: 11px; margin-top: 5px; padding: 4px 8px; border-radius: 4px;';
            
            if (status === 'uploading') {
                statusDiv.textContent = '⏳ Uploading to Imgur...';
                statusDiv.style.background = '#fff3cd';
                statusDiv.style.color = '#856404';
            } else if (status === 'success') {
                statusDiv.textContent = '✅ Hosted on Imgur';
                statusDiv.style.background = '#d4edda';
                statusDiv.style.color = '#155724';
            }
            
            if (!preview.querySelector('.upload-status')) {
                preview.appendChild(statusDiv);
            }
        }

        function removeImage(inputId, imageKey) {
            newsletterData.images[imageKey] = null;
            document.getElementById(inputId).value = '';
            document.getElementById(inputId + 'Preview').style.display = 'none';
            updatePreview();
            showToast('🗑️ Image removed', 'info');
        }

        function removeEventImage() {
            newsletterData.images.currentEventImage = null;
            document.getElementById('eventImage').value = '';
            document.getElementById('eventImagePreview').style.display = 'none';
            showToast('🗑️ Event image removed', 'info');
        }

        function handleEventImageUpload() {
            const input = document.getElementById('eventImage');
            const file = input.files[0];
            
            if (file) {
                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    showToast('❌ Image size must be less than 5MB', 'error');
                    input.value = '';
                    return;
                }
                
                // Show uploading status immediately
                showEventImagePreview(null, 'uploading');
                
                // Upload directly to Imgur
                uploadToImgur(file, 'currentEventImage').then(imgurUrl => {
                    if (imgurUrl) {
                        showEventImagePreview(imgurUrl, 'success');
                    } else {
                        // Upload failed, hide preview
                        document.getElementById('eventImagePreview').style.display = 'none';
                        input.value = '';
                    }
                });
            }
        }

        function showEventImagePreview(imageSrc, status = 'success') {
            const preview = document.getElementById('eventImagePreview');
            const img = preview.querySelector('img');
            
            if (status === 'uploading') {
                preview.style.display = 'block';
                img.style.opacity = '0.5';
                img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjgwIiB2aWV3Qm94PSIwIDAgMTIwIDgwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cmVjdCB3aWR0aD0iMTIwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjZjBmMGYwIiByeD0iNCIvPgo8dGV4dCB4PSI1MCUiIHk9IjUwJSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IiM5OTkiPuKBquKBquKBqvCfk6Q8L3RleHQ+Cjwvc3ZnPg=='; // Placeholder loading image
            } else if (status === 'success' && imageSrc) {
                img.style.opacity = '1';
                img.src = imageSrc;
                preview.style.display = 'block';
            }
            
            // Update status indicator
            const statusDiv = preview.querySelector('.upload-status') || document.createElement('div');
            statusDiv.className = 'upload-status';
            statusDiv.style.cssText = 'font-size: 11px; margin-top: 5px; padding: 4px 8px; border-radius: 4px;';
            
            if (status === 'uploading') {
                statusDiv.textContent = '⏳ Uploading to Imgur...';
                statusDiv.style.background = '#fff3cd';
                statusDiv.style.color = '#856404';
            } else if (status === 'success') {
                statusDiv.textContent = '✅ Hosted on Imgur';
                statusDiv.style.background = '#d4edda';
                statusDiv.style.color = '#155724';
            }
            
            if (!preview.querySelector('.upload-status')) {
                preview.appendChild(statusDiv);
            }
        }

        // Toast system
        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast--${type}`;
            toast.textContent = message;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // Modal manager
        const modalManager = {
            show: (modalId) => {
                const modal = document.getElementById(modalId);
                if (modal) modal.classList.add('modal-overlay--show');
            },
            close: (modalId) => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('modal-overlay--show');
                    const form = modal.querySelector('form');
                    if (form) {
                        form.reset();
                        // Clear any validation messages
                        const validationMessages = form.querySelectorAll('.validation-message');
                        validationMessages.forEach(msg => {
                            msg.style.display = 'none';
                            msg.classList.remove('error', 'success', 'warning');
                        });
                        
                        // Clear event image preview if closing add event modal
                        if (modalId === 'addEventModal') {
                            newsletterData.images.currentEventImage = null;
                            document.getElementById('eventImagePreview').style.display = 'none';
                            document.getElementById('eventDetailsLink').value = '';
                        }
                    }
                }
            }
        };

        // Close modal when clicking outside
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                const modalId = e.target.id;
                modalManager.close(modalId);
            }
        });

        // Close modal with escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const openModal = document.querySelector('.modal-overlay--show');
                if (openModal) {
                    modalManager.close(openModal.id);
                }
            }
        });

        // Form handling
        function handleFormChange(fieldId, value) {
            const fieldMap = {
                'bannerStyle': 'design.bannerStyle',
                'headerFont': 'design.headerFont',
                'bodyFont': 'design.bodyFont',
                'newsletterSeason': 'content.newsletterSeason',
                'customSubtitle': 'content.customSubtitle',
                'agentName': 'agent.name',
                'companyName': 'agent.company',
                'agentPhone': 'agent.phone',
                'agentEmail': 'agent.email',
                'agentWebsite': 'agent.website',
                'buyersGuideUrl': 'agent.buyersGuideUrl',
                'sellersGuideUrl': 'agent.sellersGuideUrl',
                'myWebsiteUrl': 'agent.myWebsiteUrl',
                'blogUrl': 'agent.blogUrl',
                'personalMessage': 'content.personalMessage',
                'customMaintenanceTips': 'content.customMaintenanceTips',
                'marketButtonText': 'content.marketButtonText',
                'marketButtonUrl': 'content.marketButtonUrl',
                'avgPrice': 'stats.avgPrice',
                'priceChange': 'stats.priceChange',
                'daysOnMarket': 'stats.daysOnMarket',
                'homesSold': 'stats.homesSold',
                'salesChange': 'stats.salesChange',
                'newListings': 'stats.newListings',
                'listingsChange': 'stats.listingsChange',
                'inventory': 'stats.inventory',
                'inventoryChange': 'stats.inventoryChange',
                'monthsOfSupply': 'stats.monthsOfSupply',
                'supplyChange': 'stats.supplyChange',
                
                'detachedPrice': 'stats.detachedPrice',
                'detachedChange': 'stats.detachedChange',
                'detachedSales': 'stats.detachedSales',
                'detachedSalesChange': 'stats.detachedSalesChange',
                'detachedListings': 'stats.detachedListings',
                'detachedListingsChange': 'stats.detachedListingsChange',
                'detachedInventory': 'stats.detachedInventory',
                'detachedInventoryChange': 'stats.detachedInventoryChange',
                'detachedSupply': 'stats.detachedSupply',
                
                'semiPrice': 'stats.semiPrice',
                'semiChange': 'stats.semiChange',
                'semiSales': 'stats.semiSales',
                'semiSalesChange': 'stats.semiSalesChange',
                'semiListings': 'stats.semiListings',
                'semiListingsChange': 'stats.semiListingsChange',
                'semiInventory': 'stats.semiInventory',
                'semiInventoryChange': 'stats.semiInventoryChange',
                'semiSupply': 'stats.semiSupply',
                
                'rowPrice': 'stats.rowPrice',
                'rowChange': 'stats.rowChange',
                'rowSales': 'stats.rowSales',
                'rowSalesChange': 'stats.rowSalesChange',
                'rowListings': 'stats.rowListings',
                'rowListingsChange': 'stats.rowListingsChange',
                'rowInventory': 'stats.rowInventory',
                'rowInventoryChange': 'stats.rowInventoryChange',
                'rowSupply': 'stats.rowSupply',
                
                'apartmentPrice': 'stats.apartmentPrice',
                'apartmentChange': 'stats.apartmentChange',
                'apartmentSales': 'stats.apartmentSales',
                'apartmentSalesChange': 'stats.apartmentSalesChange',
                'apartmentListings': 'stats.apartmentListings',
                'apartmentListingsChange': 'stats.apartmentListingsChange',
                'apartmentInventory': 'stats.apartmentInventory',
                'apartmentInventoryChange': 'stats.apartmentInventoryChange',
                'apartmentSupply': 'stats.apartmentSupply',
                'customBanner': 'images.customBanner'
            };
            
            if (fieldMap[fieldId]) {
                const keys = fieldMap[fieldId].split('.');
                let obj = newsletterData;
                for (let i = 0; i < keys.length - 1; i++) {
                    obj = obj[keys[i]];
                }
                obj[keys[keys.length - 1]] = value;
            }
            
            if (fieldId === 'bannerStyle') {
                // Show/hide custom banner upload based on selection
                const customUpload = document.getElementById('customBannerUpload');
                if (value === 'custom') {
                    customUpload.style.display = 'block';
                } else {
                    customUpload.style.display = 'none';
                }
            }
            
            if (fieldId === 'newsletterSeason') {
                updateMonthDisplay();
                const seasonConfig = SEASONS[value];
                if (seasonConfig) {
                    // Update personal message if it hasn't been customized
                    if (seasonConfig.personalMessage) {
                        const messageField = document.getElementById('personalMessage');
                        if (messageField) {
                            messageField.value = seasonConfig.personalMessage;
                            newsletterData.content.personalMessage = seasonConfig.personalMessage;
                        }
                    }
                    // Update subtitle field with seasonal default
                    if (seasonConfig.subtitle) {
                        const subtitleField = document.getElementById('customSubtitle');
                        if (subtitleField) {
                            subtitleField.value = seasonConfig.subtitle;
                            newsletterData.content.customSubtitle = seasonConfig.subtitle;
                        }
                    }
                }
            }
            
            updatePreview();
        }

        // Stats rendering
        function renderStats() {
            const statsConfig = [
                { id: 'avgPrice', label: 'Total Residential Price', field: 'avgPrice', section: 'main' },
                { id: 'priceChange', label: 'Price Change Y/Y', field: 'priceChange', section: 'main' },
                { id: 'homesSold', label: 'Total Sales', field: 'homesSold', section: 'main' },
                { id: 'salesChange', label: 'Sales Change Y/Y', field: 'salesChange', section: 'main' },
                { id: 'newListings', label: 'Total New Listings', field: 'newListings', section: 'main' },
                { id: 'listingsChange', label: 'Listings Change Y/Y', field: 'listingsChange', section: 'main' },
                { id: 'inventory', label: 'Total Inventory', field: 'inventory', section: 'main' },
                { id: 'inventoryChange', label: 'Inventory Change Y/Y', field: 'inventoryChange', section: 'main' },
                { id: 'monthsOfSupply', label: 'Months of Supply', field: 'monthsOfSupply', section: 'main' },
                { id: 'supplyChange', label: 'Supply Change Y/Y', field: 'supplyChange', section: 'main' },
                { id: 'daysOnMarket', label: 'Days on Market', field: 'daysOnMarket', section: 'main' },
                
                { id: 'detachedPrice', label: 'Price', field: 'detachedPrice', section: 'detached' },
                { id: 'detachedChange', label: 'Price Change Y/Y', field: 'detachedChange', section: 'detached' },
                { id: 'detachedSales', label: 'Sales', field: 'detachedSales', section: 'detached' },
                { id: 'detachedSalesChange', label: 'Sales Change Y/Y', field: 'detachedSalesChange', section: 'detached' },
                { id: 'detachedListings', label: 'New Listings', field: 'detachedListings', section: 'detached' },
                { id: 'detachedListingsChange', label: 'Listings Change Y/Y', field: 'detachedListingsChange', section: 'detached' },
                { id: 'detachedInventory', label: 'Inventory', field: 'detachedInventory', section: 'detached' },
                { id: 'detachedSupply', label: 'Months Supply', field: 'detachedSupply', section: 'detached' },
                
                { id: 'semiPrice', label: 'Price', field: 'semiPrice', section: 'semi' },
                { id: 'semiChange', label: 'Price Change Y/Y', field: 'semiChange', section: 'semi' },
                { id: 'semiSales', label: 'Sales', field: 'semiSales', section: 'semi' },
                { id: 'semiSalesChange', label: 'Sales Change Y/Y', field: 'semiSalesChange', section: 'semi' },
                { id: 'semiListings', label: 'New Listings', field: 'semiListings', section: 'semi' },
                { id: 'semiListingsChange', label: 'Listings Change Y/Y', field: 'semiListingsChange', section: 'semi' },
                { id: 'semiInventory', label: 'Inventory', field: 'semiInventory', section: 'semi' },
                { id: 'semiSupply', label: 'Months Supply', field: 'semiSupply', section: 'semi' },
                
                { id: 'rowPrice', label: 'Price', field: 'rowPrice', section: 'row' },
                { id: 'rowChange', label: 'Price Change Y/Y', field: 'rowChange', section: 'row' },
                { id: 'rowSales', label: 'Sales', field: 'rowSales', section: 'row' },
                { id: 'rowSalesChange', label: 'Sales Change Y/Y', field: 'rowSalesChange', section: 'row' },
                { id: 'rowListings', label: 'New Listings', field: 'rowListings', section: 'row' },
                { id: 'rowListingsChange', label: 'Listings Change Y/Y', field: 'rowListingsChange', section: 'row' },
                { id: 'rowInventory', label: 'Inventory', field: 'rowInventory', section: 'row' },
                { id: 'rowSupply', label: 'Months Supply', field: 'rowSupply', section: 'row' },
                
                { id: 'apartmentPrice', label: 'Price', field: 'apartmentPrice', section: 'apartment' },
                { id: 'apartmentChange', label: 'Price Change Y/Y', field: 'apartmentChange', section: 'apartment' },
                { id: 'apartmentSales', label: 'Sales', field: 'apartmentSales', section: 'apartment' },
                { id: 'apartmentSalesChange', label: 'Sales Change Y/Y', field: 'apartmentSalesChange', section: 'apartment' },
                { id: 'apartmentListings', label: 'New Listings', field: 'apartmentListings', section: 'apartment' },
                { id: 'apartmentListingsChange', label: 'Listings Change Y/Y', field: 'apartmentListingsChange', section: 'apartment' },
                { id: 'apartmentInventory', label: 'Inventory', field: 'apartmentInventory', section: 'apartment' },
                { id: 'apartmentSupply', label: 'Months Supply', field: 'apartmentSupply', section: 'apartment' }
            ];

            const container = document.getElementById('statsGrid');
            
            const mainStats = statsConfig.filter(s => s.section === 'main');
            const detachedStats = statsConfig.filter(s => s.section === 'detached');
            const semiStats = statsConfig.filter(s => s.section === 'semi');
            const rowStats = statsConfig.filter(s => s.section === 'row');
            const apartmentStats = statsConfig.filter(s => s.section === 'apartment');
            
            container.innerHTML = `
                <div style="margin-bottom: 25px;">
                    <div style="font-size: 13px; font-weight: 600; color: #EA102A; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px;">📊 Main Market Indicators</div>
                    ${mainStats.map(stat => `
                        <div class="stat-item" style="margin-bottom: 8px;">
                            <label class="stat-item__label">${stat.label}</label>
                            <input type="text" class="stat-item__input" id="${stat.id}" value="${newsletterData.stats[stat.field] || ''}" oninput="handleFormChange('${stat.id}', this.value)">
                        </div>
                    `).join('')}
                </div>
                
                <div style="margin-bottom: 25px;">
                    <div style="font-size: 13px; font-weight: 600; color: #dc3545; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px;">🏠 Detached Homes</div>
                    ${detachedStats.map(stat => `
                        <div class="stat-item" style="margin-bottom: 8px;">
                            <label class="stat-item__label">${stat.label}</label>
                            <input type="text" class="stat-item__input" id="${stat.id}" value="${newsletterData.stats[stat.field] || ''}" oninput="handleFormChange('${stat.id}', this.value)">
                        </div>
                    `).join('')}
                </div>
                
                <div style="margin-bottom: 25px;">
                    <div style="font-size: 13px; font-weight: 600; color: #2563eb; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px;">🏘️ Semi-Detached</div>
                    ${semiStats.map(stat => `
                        <div class="stat-item" style="margin-bottom: 8px;">
                            <label class="stat-item__label">${stat.label}</label>
                            <input type="text" class="stat-item__input" id="${stat.id}" value="${newsletterData.stats[stat.field] || ''}" oninput="handleFormChange('${stat.id}', this.value)">
                        </div>
                    `).join('')}
                </div>
                
                <div style="margin-bottom: 25px;">
                    <div style="font-size: 13px; font-weight: 600; color: #28a745; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px;">🏘️ Row/Townhomes</div>
                    ${rowStats.map(stat => `
                        <div class="stat-item" style="margin-bottom: 8px;">
                            <label class="stat-item__label">${stat.label}</label>
                            <input type="text" class="stat-item__input" id="${stat.id}" value="${newsletterData.stats[stat.field] || ''}" oninput="handleFormChange('${stat.id}', this.value)">
                        </div>
                    `).join('')}
                </div>
                
                <div style="margin-bottom: 25px;">
                    <div style="font-size: 13px; font-weight: 600; color: #ff9800; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px;">🏢 Apartments/Condos</div>
                    ${apartmentStats.map(stat => `
                        <div class="stat-item" style="margin-bottom: 8px;">
                            <label class="stat-item__label">${stat.label}</label>
                            <input type="text" class="stat-item__input" id="${stat.id}" value="${newsletterData.stats[stat.field] || ''}" oninput="handleFormChange('${stat.id}', this.value)">
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Month display update
        function updateMonthDisplay() {
            const month = newsletterData.content.newsletterSeason || 'june';
            const monthName = month.charAt(0).toUpperCase() + month.slice(1);
            document.getElementById('currentMonth').textContent = `${monthName} 2025 Edition`;
        }

        // Get maintenance tips
        function getMaintenanceTips(config) {
            const customTips = newsletterData.content.customMaintenanceTips;
            
            if (customTips && customTips.trim().length > 0) {
                return customTips.split('\n')
                    .map(tip => tip.trim())
                    .filter(tip => tip.length > 0)
                    .map(tip => tip.startsWith('•') || tip.startsWith('-') || tip.startsWith('🔧') || tip.startsWith('🏠') || tip.startsWith('❄️') || tip.startsWith('🌿') || tip.startsWith('☀️') || tip.startsWith('🍂') || tip.startsWith('🎄') ? tip : `🔧 ${tip}`);
            }
            
            return config.tips;
        }

        // Preview generation
        function updatePreview() {
            const season = newsletterData.content.newsletterSeason;
            const config = SEASONS[season];
            
            const template = `
                <div style="max-width: 650px; margin: 0 auto; background: white; font-family: ${newsletterData.design.bodyFont}; color: #333;">
                    <!-- Header Section -->
                    <div style="text-align: center; padding: 40px 20px 30px;">
                        ${generateBannerHtml()}
                        
                        <!-- Subtitle -->
                        <div style="text-align: center; margin: 30px 0;">
                            <div style="font-family: ${newsletterData.design.headerFont}; font-size: 28px; font-weight: 300; color: #333;">${newsletterData.content.customSubtitle || config.subtitle}</div>
                        </div>
                        
                        <!-- Personal Message -->
                        <div style="max-width: 500px; margin: 40px auto 30px auto; text-align: center; padding: 25px; background: #f8f9fa; border-left: 4px solid #EA102A; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                            <p style="font-size: 16px; line-height: 1.8; color: #555; margin: 0; font-weight: 400; font-style: italic;">${newsletterData.content.personalMessage || 'Personal message not found - check data'}</p>
                        </div>
                        
                        <!-- Action Buttons -->
                        ${(newsletterData.agent.buyersGuideUrl || newsletterData.agent.sellersGuideUrl || newsletterData.agent.myWebsiteUrl || newsletterData.agent.blogUrl) ? `
                        <div style="max-width: 600px; margin: 40px auto 0; padding: 0 20px;">
                            <!-- First Row: Buyer's and Seller's Guide -->
                            ${(newsletterData.agent.buyersGuideUrl || newsletterData.agent.sellersGuideUrl) ? `
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                ${newsletterData.agent.buyersGuideUrl ? `
                                <a href="${newsletterData.agent.buyersGuideUrl}" style="display: block; background: #EA102A; color: white; padding: 12px 16px; text-decoration: none; border-radius: 6px; font-weight: 600; font-size: 13px; text-align: center; text-transform: uppercase; letter-spacing: 0.5px; transition: all 0.3s ease;" target="_blank">
                                    📚 Buyers Guide
                                </a>
                                ` : '<div></div>'}
                                ${newsletterData.agent.sellersGuideUrl ? `
                                <a href="${newsletterData.agent.sellersGuideUrl}" style="display: block; background: #2563eb; color: white; padding: 12px 16px; text-decoration: none; border-radius: 6px; font-weight: 600; font-size: 13px; text-align: center; text-transform: uppercase; letter-spacing: 0.5px; transition: all 0.3s ease;" target="_blank">
                                    📋 Sellers Guide
                                </a>
                                ` : '<div></div>'}
                            </div>
                            ` : ''}
                            <!-- Second Row: Website and Blog -->
                            ${(newsletterData.agent.myWebsiteUrl || newsletterData.agent.blogUrl) ? `
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                ${newsletterData.agent.myWebsiteUrl ? `
                                <a href="${newsletterData.agent.myWebsiteUrl}" style="display: block; background: #28a745; color: white; padding: 12px 16px; text-decoration: none; border-radius: 6px; font-weight: 600; font-size: 13px; text-align: center; text-transform: uppercase; letter-spacing: 0.5px; transition: all 0.3s ease;" target="_blank">
                                    🌐 My Website
                                </a>
                                ` : '<div></div>'}
                                ${newsletterData.agent.blogUrl ? `
                                <a href="${newsletterData.agent.blogUrl}" style="display: block; background: #ff9800; color: white; padding: 12px 16px; text-decoration: none; border-radius: 6px; font-weight: 600; font-size: 13px; text-align: center; text-transform: uppercase; letter-spacing: 0.5px; transition: all 0.3s ease;" target="_blank">
                                    ✍️ Blog
                                </a>
                                ` : '<div></div>'}
                            </div>
                            ` : ''}
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- Market Statistics -->
                    <div style="height: 1px; background: #e0e0e0; margin: 0 40px;"></div>
                    ${generateMarketStatsHtml()}
                    
                    <!-- Community Calendar -->
                    <div style="height: 1px; background: #e0e0e0; margin: 0 40px;"></div>
                    <div style="padding: 40px;">
                        <h2 style="font-family: ${newsletterData.design.headerFont}; font-size: 24px; font-weight: 400; text-align: center; margin-bottom: 30px;">Community CALENDAR</h2>
                        <div style="display: grid; gap: 20px;">
                            ${newsletterData.customEvents && newsletterData.customEvents.length > 0 ? 
                                // Sort events by date before displaying
                                newsletterData.customEvents
                                    .sort((a, b) => new Date(a.date) - new Date(b.date))
                                    .map(event => `
                                    <div style="display: grid; grid-template-columns: 100px 1fr ${event.image ? '150px' : ''}; gap: 20px; align-items: center; padding: 20px; border: 1px solid #f0f0f0; border-radius: 8px; background: #fafafa;">
                                        <div style="text-align: center;">
                                            <div style="background: #EA102A; color: white; padding: 8px; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; border-radius: 4px;">${formatEventDate(event.date).month}</div>
                                            <div style="font-size: 24px; font-weight: 300; color: #333;">${formatEventDate(event.date).day}</div>
                                            ${event.startTime ? `<div style="font-size: 10px; color: #666; margin-top: 5px; line-height: 1.2;">${formatEventTime(event.startTime, event.endTime)}</div>` : ''}
                                        </div>
                                        <div>
                                            <h3 style="font-size: 16px; font-weight: 500; margin-bottom: 5px; color: #333;">${event.title}</h3>
                                            ${event.startTime ? `<p style="font-size: 13px; color: #666; margin: 0 0 5px 0;">🕐 ${formatEventTime(event.startTime, event.endTime)}</p>` : ''}
                                            ${event.location ? `<p style="font-size: 13px; color: #666; margin: 0 0 5px 0;">📍 ${event.location}</p>` : ''}
                                            ${event.description ? `<p style="font-size: 12px; color: #999; margin: 5px 0 0 0; font-style: italic; line-height: 1.4;">${event.description}</p>` : ''}
                                            ${event.detailsLink ? `
                                            <div style="margin-top: 15px;">
                                                <a href="${event.detailsLink}" style="display: inline-block; background: #EA102A; color: white; padding: 8px 16px; text-decoration: none; border-radius: 5px; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;" target="_blank">
                                                    📋 Event Details
                                                </a>
                                            </div>
                                            ` : ''}
                                        </div>
                                        ${event.image ? `
                                        <div style="text-align: center;">
                                            <img src="${event.image}" style="width: 140px; height: 100px; object-fit: cover; border-radius: 6px; border: 2px solid #e0e0e0;" alt="Event Image">
                                        </div>
                                        ` : ''}
                                    </div>
                                `).join('') :
                                `<div style="text-align: center; padding: 40px 20px; color: #999; font-style: italic;">
                                    <div style="font-size: 48px; margin-bottom: 15px;">📅</div>
                                    <p style="font-size: 16px; margin: 0;">No events added yet</p>
                                    <p style="font-size: 14px; margin: 5px 0 0 0;">Click "Add Event" to create your community calendar</p>
                                </div>`
                            }
                        </div>
                    </div>
                    
                    <!-- Maintenance Tips -->
                    <div style="height: 1px; background: #e0e0e0; margin: 0 40px;"></div>
                    <div style="padding: 40px;">
                        <h2 style="font-family: ${newsletterData.design.headerFont}; font-size: 24px; font-weight: 400; text-align: center; margin-bottom: 30px;">${newsletterData.content.newsletterSeason.charAt(0).toUpperCase() + newsletterData.content.newsletterSeason.slice(1)} Maintenance TIPS</h2>
                        <div style="background: #f9f9f9; padding: 30px; border-radius: 8px;">
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                ${getMaintenanceTips(config).map(tip => `
                                    <li style="padding: 10px 0; border-bottom: 1px solid #e0e0e0; font-size: 14px; color: #666;">${tip}</li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Agent Contact -->
                    <div style="background: #f9f9f9; padding: 40px; text-align: center;">
                        ${newsletterData.images.brokerageLogo ? `
                        <div style="margin-bottom: 30px;">
                            <img src="${newsletterData.images.brokerageLogo}" style="max-width: 200px; max-height: 80px; object-fit: contain;" alt="Brokerage Logo">
                        </div>
                        ` : ''}
                        
                        <div style="display: inline-flex; align-items: center; gap: 30px;">
                            <div style="width: 100px; height: 100px; border-radius: 50%; overflow: hidden; background: #e0e0e0;">
                                ${newsletterData.images.agentPhoto ? 
                                    `<img src="${newsletterData.images.agentPhoto}" style="width: 100%; height: 100%; object-fit: cover;" alt="Agent Photo">` :
                                    `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #999; font-size: 12px;">Agent Photo</div>`
                                }
                            </div>
                            <div style="text-align: left;">
                                <h3 style="font-family: ${newsletterData.design.headerFont}; font-size: 22px; font-weight: 400; margin-bottom: 5px;">${newsletterData.agent.name}</h3>
                                <p style="font-size: 13px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px;">${newsletterData.agent.company}</p>
                                <p style="font-size: 14px; margin: 5px 0;">📱 ${newsletterData.agent.phone}</p>
                                <p style="font-size: 14px; margin: 5px 0;">✉️ ${newsletterData.agent.email}</p>
                            </div>
                            ${newsletterData.images.agentLogo ? `
                            <div style="margin-left: 20px;">
                                <img src="${newsletterData.images.agentLogo}" style="max-width: 120px; max-height: 80px; object-fit: contain;" alt="Agent Logo">
                            </div>
                            ` : ''}
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <a href="http://${newsletterData.agent.website}" style="color: #EA102A; text-decoration: none; font-size: 14px;">${newsletterData.agent.website}</a>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('newsletterPreview').innerHTML = template;
        }

        function generateBannerHtml() {
            const bannerStyle = newsletterData.design.bannerStyle;
            const headerFont = newsletterData.design.headerFont;
            const config = SEASONS[newsletterData.content.newsletterSeason];
            
            switch (bannerStyle) {
                case 'mountains':
                    return `
                        <div style="position: relative; margin: 40px 0 60px 0; padding: 50px 20px;">
                            <div style="position: relative; width: 600px; height: 300px; border-radius: 20px; overflow: hidden; background-image: url('https://i.imgur.com/0dARtuj.png'); background-size: cover; background-position: center; margin: 0 auto;">
                                <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3);"></div>
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 3;">
                                    <h1 style="font-family: ${headerFont}; font-size: 42px; font-weight: 400; letter-spacing: 4px; margin: 0; color: white; text-shadow: 0 4px 20px rgba(0,0,0,0.5);">${config.title}</h1>
                                </div>
                            </div>
                        </div>
                    `;

                case 'cityscape':
                    return `
                        <div style="position: relative; margin: 40px 0 60px 0; padding: 50px 20px;">
                            <div style="position: relative; width: 600px; height: 300px; border-radius: 20px; overflow: hidden; background-image: url('https://i.imgur.com/qok5dLZ.png'); background-size: cover; background-position: center; margin: 0 auto;">
                                <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3);"></div>
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 3;">
                                    <h1 style="font-family: ${headerFont}; font-size: 42px; font-weight: 400; letter-spacing: 4px; margin: 0; color: white; text-shadow: 0 4px 20px rgba(0,0,0,0.5);">${config.title}</h1>
                                </div>
                            </div>
                        </div>
                    `;

                case 'blueprint':
                    return `
                        <div style="position: relative; margin: 40px 0 60px 0; padding: 50px 20px;">
                            <div style="position: relative; width: 600px; height: 300px; border-radius: 20px; overflow: hidden; background-image: url('https://i.imgur.com/W24OelN.png'); background-size: cover; background-position: center; margin: 0 auto;">
                                <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3);"></div>
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 3;">
                                    <h1 style="font-family: ${headerFont}; font-size: 42px; font-weight: 400; letter-spacing: 4px; margin: 0; color: white; text-shadow: 0 4px 20px rgba(0,0,0,0.5);">${config.title}</h1>
                                </div>
                            </div>
                        </div>
                    `;

                case 'custom':
                    return `
                        <div style="position: relative; margin: 40px 0 60px 0; padding: 50px 20px;">
                            ${newsletterData.images.customBanner ? `
                            <div style="position: relative; width: 600px; height: 300px; border-radius: 20px; overflow: hidden; background-image: url('${newsletterData.images.customBanner}'); background-size: cover; background-position: center; margin: 0 auto;">
                                <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3);"></div>
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 3;">
                                    <h1 style="font-family: ${headerFont}; font-size: 42px; font-weight: 400; letter-spacing: 4px; margin: 0; color: white; text-shadow: 0 4px 20px rgba(0,0,0,0.7);">${config.title}</h1>
                                </div>
                            </div>
                            ` : `
                            <div style="position: relative; width: 600px; height: 300px; border-radius: 20px; overflow: hidden; background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); margin: 0 auto;">
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 3;">
                                    <h1 style="font-family: ${headerFont}; font-size: 42px; font-weight: 400; letter-spacing: 4px; margin: 0; color: white; text-shadow: 0 4px 20px rgba(0,0,0,0.5);">${config.title}</h1>
                                    <p style="color: white; font-size: 14px; margin-top: 10px; opacity: 0.9;">Upload custom banner image above</p>
                                </div>
                            </div>
                            `}
                        </div>
                    `;

                case 'minimal':
                    return `
                        <div style="text-align: center; margin: 40px 0; padding: 50px 20px;">
                            <div style="border-bottom: 2px solid #EA102A; display: inline-block; margin-bottom: 40px; padding-bottom: 10px;">
                                <h1 style="font-family: ${headerFont}; font-size: 36px; font-weight: 300; letter-spacing: 3px; margin: 0; color: #333;">${config.title}</h1>
                            </div>
                        </div>
                    `;

                case 'none':
                    return `
                        <div style="text-align: center; margin: 40px 0; padding: 20px;">
                            <h1 style="font-family: ${headerFont}; font-size: 36px; font-weight: 400; letter-spacing: 3px; margin: 0; color: #333;">${config.title}</h1>
                        </div>
                    `;

                default:
                    return `
                        <div style="text-align: center; margin: 40px 0;">
                            <h1 style="font-family: ${headerFont}; font-size: 36px; font-weight: 400; letter-spacing: 3px; margin: 0; color: #333;">${config.title}</h1>
                        </div>
                    `;
            }
        }

        function generateMarketStatsHtml() {
            const stats = newsletterData.stats;
            const headerFont = newsletterData.design.headerFont;
            
            // Get previous month name
            const currentMonth = newsletterData.content.newsletterSeason || 'june';
            const monthNames = ['january', 'february', 'march', 'april', 'may', 'june', 'july', 'august', 'september', 'october', 'november', 'december'];
            const currentIndex = monthNames.indexOf(currentMonth);
            const previousIndex = currentIndex === 0 ? 11 : currentIndex - 1;
            const previousMonth = monthNames[previousIndex].charAt(0).toUpperCase() + monthNames[previousIndex].slice(1);
            
            return `
                <div style="padding: 40px;">
                    <h2 style="font-family: ${headerFont}; font-size: 24px; font-weight: 400; text-align: center; margin-bottom: 30px;">Snapshot of ${previousMonth} STATISTICS</h2>
                    
                    <!-- Main Market Indicators -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
                        <div style="text-align: center; padding: 20px; background: #f9f9f9; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: 600; color: #EA102A; margin-bottom: 5px;">${stats.avgPrice}</div>
                            <div style="font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px;">Total Residential Price</div>
                            <div style="font-size: 14px; font-weight: 500; color: ${stats.priceChange && stats.priceChange.startsWith('-') ? '#dc3545' : '#28a745'};">${stats.priceChange} Y/Y</div>
                        </div>
                        <div style="text-align: center; padding: 20px; background: #f9f9f9; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: 600; color: #2563eb; margin-bottom: 5px;">${stats.homesSold}</div>
                            <div style="font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px;">Sales</div>
                            <div style="font-size: 14px; font-weight: 500; color: ${stats.salesChange && stats.salesChange.startsWith('-') ? '#dc3545' : '#28a745'};">${stats.salesChange || 'N/A'} Y/Y</div>
                        </div>
                        <div style="text-align: center; padding: 20px; background: #f9f9f9; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: 600; color: #28a745; margin-bottom: 5px;">${stats.newListings}</div>
                            <div style="font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px;">New Listings</div>
                            <div style="font-size: 14px; font-weight: 500; color: ${stats.listingsChange && stats.listingsChange.startsWith('-') ? '#dc3545' : '#28a745'};">${stats.listingsChange || 'N/A'} Y/Y</div>
                        </div>
                    </div>
                    
                    <!-- Supply Metrics -->
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px;">
                        <div style="text-align: center; padding: 20px; background: #f9f9f9; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: 600; color: #ff9800; margin-bottom: 5px;">${stats.inventory}</div>
                            <div style="font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px;">Total Inventory</div>
                            <div style="font-size: 14px; font-weight: 500; color: ${stats.inventoryChange && stats.inventoryChange.startsWith('-') ? '#dc3545' : '#28a745'};">${stats.inventoryChange || 'N/A'} Y/Y</div>
                        </div>
                        <div style="text-align: center; padding: 20px; background: #f9f9f9; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: 600; color: #6366f1; margin-bottom: 5px;">${stats.monthsOfSupply || stats.daysOnMarket + ' days'}</div>
                            <div style="font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px;">${stats.monthsOfSupply ? 'Months of Supply' : 'Days on Market'}</div>
                            <div style="font-size: 14px; font-weight: 500; color: ${stats.supplyChange && stats.supplyChange.startsWith('-') ? '#dc3545' : '#28a745'};">${stats.supplyChange || 'Balanced'}</div>
                        </div>
                    </div>
                    
                    <!-- Property Type Breakdown -->
                    ${(stats.detachedPrice || stats.semiPrice || stats.rowPrice || stats.apartmentPrice) ? `
                    <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-bottom: 25px;">
                        <h3 style="font-family: ${headerFont}; font-size: 18px; font-weight: 500; text-align: center; margin-bottom: 25px; color: #333;">Property Type Market Analysis</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                            ${stats.detachedPrice ? `
                            <div style="background: white; padding: 20px; border-radius: 12px; border-left: 4px solid #EA102A; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                                <div style="font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; font-weight: 600;">🏠 Detached Homes</div>
                                <div style="font-size: 22px; font-weight: 700; color: #333; margin-bottom: 8px;">${stats.detachedPrice}</div>
                                <div style="font-size: 13px; color: ${stats.detachedChange && stats.detachedChange.startsWith('-') ? '#dc3545' : '#28a745'}; font-weight: 600; margin-bottom: 15px;">${stats.detachedChange || 'N/A'} Y/Y</div>
                                
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 12px;">
                                    <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 16px; font-weight: 600; color: #EA102A;">${stats.detachedSales || 'N/A'}</div>
                                        <div style="font-size: 10px; color: #666; text-transform: uppercase;">Sales</div>
                                        ${stats.detachedSalesChange ? `<div style="font-size: 10px; color: ${stats.detachedSalesChange.startsWith('-') ? '#dc3545' : '#28a745'};">${stats.detachedSalesChange}</div>` : ''}
                                    </div>
                                    <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 16px; font-weight: 600; color: #2563eb;">${stats.detachedListings || 'N/A'}</div>
                                        <div style="font-size: 10px; color: #666; text-transform: uppercase;">Listings</div>
                                        ${stats.detachedListingsChange ? `<div style="font-size: 10px; color: ${stats.detachedListingsChange.startsWith('-') ? '#dc3545' : '#28a745'};">${stats.detachedListingsChange}</div>` : ''}
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                    <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 16px; font-weight: 600; color: #28a745;">${stats.detachedInventory || 'N/A'}</div>
                                        <div style="font-size: 10px; color: #666; text-transform: uppercase;">Inventory</div>
                                    </div>
                                    <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 16px; font-weight: 600; color: #ff9800;">${stats.detachedSupply || 'N/A'}</div>
                                        <div style="font-size: 10px; color: #666; text-transform: uppercase;">Mos. Supply</div>
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                            
                            ${stats.semiPrice ? `
                            <div style="background: white; padding: 20px; border-radius: 12px; border-left: 4px solid #2563eb; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                                <div style="font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; font-weight: 600;">🏘️ Semi-Detached</div>
                                <div style="font-size: 22px; font-weight: 700; color: #333; margin-bottom: 8px;">${stats.semiPrice}</div>
                                <div style="font-size: 13px; color: ${stats.semiChange && stats.semiChange.startsWith('-') ? '#dc3545' : '#28a745'}; font-weight: 600; margin-bottom: 15px;">${stats.semiChange || 'N/A'} Y/Y</div>
                                
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 12px;">
                                    <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 16px; font-weight: 600; color: #EA102A;">${stats.semiSales || 'N/A'}</div>
                                        <div style="font-size: 10px; color: #666; text-transform: uppercase;">Sales</div>
                                        ${stats.semiSalesChange ? `<div style="font-size: 10px; color: ${stats.semiSalesChange.startsWith('-') ? '#dc3545' : '#28a745'};">${stats.semiSalesChange}</div>` : ''}
                                    </div>
                                    <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 16px; font-weight: 600; color: #2563eb;">${stats.semiListings || 'N/A'}</div>
                                        <div style="font-size: 10px; color: #666; text-transform: uppercase;">Listings</div>
                                        ${stats.semiListingsChange ? `<div style="font-size: 10px; color: ${stats.semiListingsChange.startsWith('-') ? '#dc3545' : '#28a745'};">${stats.semiListingsChange}</div>` : ''}
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                    <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 16px; font-weight: 600; color: #28a745;">${stats.semiInventory || 'N/A'}</div>
                                        <div style="font-size: 10px; color: #666; text-transform: uppercase;">Inventory</div>
                                    </div>
                                    <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 16px; font-weight: 600; color: #ff9800;">${stats.semiSupply || 'N/A'}</div>
                                        <div style="font-size: 10px; color: #666; text-transform: uppercase;">Mos. Supply</div>
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                            
                            ${stats.rowPrice ? `
                            <div style="background: white; padding: 20px; border-radius: 12px; border-left: 4px solid #28a745; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                                <div style="font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; font-weight: 600;">🏘️ Row/Townhome</div>
                                <div style="font-size: 22px; font-weight: 700; color: #333; margin-bottom: 8px;">${stats.rowPrice}</div>
                                <div style="font-size: 13px; color: ${stats.rowChange && stats.rowChange.startsWith('-') ? '#dc3545' : '#28a745'}; font-weight: 600; margin-bottom: 15px;">${stats.rowChange || 'N/A'} Y/Y</div>
                                
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 12px;">
                                    <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 16px; font-weight: 600; color: #EA102A;">${stats.rowSales || 'N/A'}</div>
                                        <div style="font-size: 10px; color: #666; text-transform: uppercase;">Sales</div>
                                        ${stats.rowSalesChange ? `<div style="font-size: 10px; color: ${stats.rowSalesChange.startsWith('-') ? '#dc3545' : '#28a745'};">${stats.rowSalesChange}</div>` : ''}
                                    </div>
                                    <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 16px; font-weight: 600; color: #2563eb;">${stats.rowListings || 'N/A'}</div>
                                        <div style="font-size: 10px; color: #666; text-transform: uppercase;">Listings</div>
                                        ${stats.rowListingsChange ? `<div style="font-size: 10px; color: ${stats.rowListingsChange.startsWith('-') ? '#dc3545' : '#28a745'};">${stats.rowListingsChange}</div>` : ''}
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                    <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 16px; font-weight: 600; color: #28a745;">${stats.rowInventory || 'N/A'}</div>
                                        <div style="font-size: 10px; color: #666; text-transform: uppercase;">Inventory</div>
                                    </div>
                                    <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 16px; font-weight: 600; color: #ff9800;">${stats.rowSupply || 'N/A'}</div>
                                        <div style="font-size: 10px; color: #666; text-transform: uppercase;">Mos. Supply</div>
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                            
                            ${stats.apartmentPrice ? `
                            <div style="background: white; padding: 20px; border-radius: 12px; border-left: 4px solid #ff9800; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                                <div style="font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; font-weight: 600;">🏢 Apartment/Condo</div>
                                <div style="font-size: 22px; font-weight: 700; color: #333; margin-bottom: 8px;">${stats.apartmentPrice}</div>
                                <div style="font-size: 13px; color: ${stats.apartmentChange && stats.apartmentChange.startsWith('-') ? '#dc3545' : '#28a745'}; font-weight: 600; margin-bottom: 15px;">${stats.apartmentChange || 'N/A'} Y/Y</div>
                                
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 12px;">
                                    <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 16px; font-weight: 600; color: #EA102A;">${stats.apartmentSales || 'N/A'}</div>
                                        <div style="font-size: 10px; color: #666; text-transform: uppercase;">Sales</div>
                                        ${stats.apartmentSalesChange ? `<div style="font-size: 10px; color: ${stats.apartmentSalesChange.startsWith('-') ? '#dc3545' : '#28a745'};">${stats.apartmentSalesChange}</div>` : ''}
                                    </div>
                                    <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 16px; font-weight: 600; color: #2563eb;">${stats.apartmentListings || 'N/A'}</div>
                                        <div style="font-size: 10px; color: #666; text-transform: uppercase;">Listings</div>
                                        ${stats.apartmentListingsChange ? `<div style="font-size: 10px; color: ${stats.apartmentListingsChange.startsWith('-') ? '#dc3545' : '#28a745'};">${stats.apartmentListingsChange}</div>` : ''}
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                    <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 16px; font-weight: 600; color: #28a745;">${stats.apartmentInventory || 'N/A'}</div>
                                        <div style="font-size: 10px; color: #666; text-transform: uppercase;">Inventory</div>
                                    </div>
                                    <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 16px; font-weight: 600; color: #ff9800;">${stats.apartmentSupply || 'N/A'}</div>
                                        <div style="font-size: 10px; color: #666; text-transform: uppercase;">Mos. Supply</div>
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Market Stats Disclaimer -->
                    <div style="background: #f8f9fa; border-left: 4px solid #17a2b8; padding: 15px; margin: 20px 0; border-radius: 6px;">
                        <div style="font-size: 11px; font-weight: 600; color: #0c5460; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">📊 Disclaimer</div>
                        <p style="font-size: 12px; line-height: 1.4; color: #0c5460; margin: 0; font-family: Arial, sans-serif;">
                            <strong>Disclaimer:</strong> The statistics and market data presented in this report have been provided by the Calgary Real Estate Board (CREB®). While every effort has been made to ensure accuracy, the information is subject to change and should not be considered as financial or investment advice.
                        </p>
                    </div>
                    
                    ${(newsletterData.content.marketButtonText && newsletterData.content.marketButtonUrl) ? `
                    <div style="text-align: center; margin-top: 30px;">
                        <a href="${newsletterData.content.marketButtonUrl}" style="display: inline-block; background: #EA102A; color: white; padding: 15px 30px; text-decoration: none; border-radius: 6px; font-weight: 600; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; transition: all 0.3s ease;" target="_blank">${newsletterData.content.marketButtonText}</a>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        // Quick print function
        function quickPrint() {
            window.scrollTo(0, 0);
            showToast('🖨️ Opening print dialog...', 'info', 2000);
            setTimeout(() => {
                window.print();
            }, 100);
        }

        // Utility functions
        function generateNewsletter() {
            updatePreview(); // Make sure preview is updated
            showToast('✨ Newsletter generated successfully!', 'success');
            document.getElementById('codeOutput').textContent = getFullHTML();
        }

        function toggleCode() {
            const codeOutput = document.getElementById('codeOutput');
            const isVisible = codeOutput.style.display !== 'none';
            
            if (!isVisible) {
                codeOutput.textContent = getFullHTML();
                codeOutput.style.display = 'block';
            } else {
                codeOutput.style.display = 'none';
            }
        }

        function copyToClipboard() {
            const html = getFullHTML();
            navigator.clipboard.writeText(html).then(() => {
                showToast('✅ HTML copied to clipboard!', 'success');
            }).catch(() => {
                showToast('❌ Failed to copy to clipboard', 'error');
            });
        }

        function getFullHTML() {
            const newsletterHtml = document.getElementById('newsletterPreview').innerHTML;
            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Estate Newsletter - ${newsletterData.content.newsletterSeason.charAt(0).toUpperCase() + newsletterData.content.newsletterSeason.slice(1)} 2025</title>
</head>
<body style="margin: 0; padding: 20px; background: #f5f5f5; font-family: Arial, sans-serif;">
    ${newsletterHtml}
</body>
</html>`;
        }

        // Export manager
        const exportManager = {
            copyEmailSafeHTML: () => {
                const html = getEmailSafeHTML();
                navigator.clipboard.writeText(html).then(() => {
                    modalManager.close('exportModal');
                    showToast('✅ Email-ready HTML copied with hosted image URLs!', 'success', 6000);
                }).catch(() => {
                    showToast('❌ Failed to copy to clipboard', 'error');
                });
            },
            
            exportAsHTML: () => {
                const html = getEmailSafeHTML(); // Use email-safe version for download too
                const blob = new Blob([html], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `newsletter-${newsletterData.content.newsletterSeason}-2025-email-safe.html`;
                a.click();
                URL.revokeObjectURL(url);
                modalManager.close('exportModal');
                showToast('✅ Newsletter exported with email-safe tables!', 'success');
            },

            printNewsletter: () => {
                modalManager.close('exportModal');
                setTimeout(() => {
                    window.scrollTo(0, 0);
                    showToast('🖨️ Opening print dialog...', 'info', 2000);
                    window.print();
                }, 300);
            }
        };

        function getEmailSafeHTML() {
            const season = newsletterData.content.newsletterSeason;
            const config = SEASONS[season];
            
            // Generate email-safe version using tables
            const emailTemplate = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Estate Newsletter - ${newsletterData.content.newsletterSeason.charAt(0).toUpperCase() + newsletterData.content.newsletterSeason.slice(1)} 2025</title>
    <meta name="x-apple-disable-message-reformatting">
    <!--[if mso]>
    <noscript>
    <xml>
    <o:OfficeDocumentSettings>
    <o:AllowPNG/>
    <o:PixelsPerInch>96</o:PixelsPerInch>
    </o:OfficeDocumentSettings>
    </xml>
    </noscript>
    <![endif]-->
</head>
<body style="margin: 0; padding: 0; background-color: #f5f5f5; font-family: Arial, sans-serif; -webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%;">
    <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="background-color: #f5f5f5;">
        <tr>
            <td align="center" style="padding: 20px;">
                
                <!-- Main Newsletter Container -->
                <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="650" style="max-width: 650px; background-color: white; margin: 0 auto;">
                    
                    <!-- Banner Section -->
                    <tr>
                        <td align="center" style="padding: 40px 20px 30px;">
                            ${generateEmailBannerHtml(config)}
                        </td>
                    </tr>
                    
                    <!-- Subtitle -->
                    <tr>
                        <td align="center" style="padding: 30px 20px;">
                            <h2 style="font-family: ${newsletterData.design.headerFont}; font-size: 28px; font-weight: 300; color: #333; margin: 0;">${newsletterData.content.customSubtitle || config.subtitle}</h2>
                        </td>
                    </tr>
                    
                    <!-- Personal Message -->
                    <tr>
                        <td style="padding: 0 40px 30px;">
                            <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">
                                <tr>
                                    <td style="background-color: #f8f9fa; border-left: 4px solid #EA102A; border-radius: 8px; padding: 25px; text-align: center;">
                                        <p style="font-family: ${newsletterData.design.bodyFont}; font-size: 16px; line-height: 1.8; color: #555; margin: 0; font-style: italic;">${newsletterData.content.personalMessage}</p>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    
                    <!-- Action Buttons -->
                    ${(newsletterData.agent.buyersGuideUrl || newsletterData.agent.sellersGuideUrl || newsletterData.agent.myWebsiteUrl || newsletterData.agent.blogUrl) ? `
                    <tr>
                        <td style="padding: 0 40px 40px;">
                            <!-- First Row: Buyer's and Seller's Guide -->
                            ${(newsletterData.agent.buyersGuideUrl || newsletterData.agent.sellersGuideUrl) ? `
                            <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="margin-bottom: 15px;">
                                <tr>
                                    ${newsletterData.agent.buyersGuideUrl ? `
                                    <td width="50%" style="padding-right: 8px;">
                                        <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">
                                            <tr>
                                                <td style="background-color: #EA102A; border-radius: 6px; text-align: center;">
                                                    <a href="${newsletterData.agent.buyersGuideUrl}" style="display: block; padding: 12px 16px; color: white; text-decoration: none; font-family: ${newsletterData.design.bodyFont}; font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;" target="_blank">📚 BUYERS GUIDE</a>
                                                </td>
                                            </tr>
                                        </table>
                                    </td>
                                    ` : '<td width="50%" style="padding-right: 8px;"></td>'}
                                    ${newsletterData.agent.sellersGuideUrl ? `
                                    <td width="50%" style="padding-left: 8px;">
                                        <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">
                                            <tr>
                                                <td style="background-color: #2563eb; border-radius: 6px; text-align: center;">
                                                    <a href="${newsletterData.agent.sellersGuideUrl}" style="display: block; padding: 12px 16px; color: white; text-decoration: none; font-family: ${newsletterData.design.bodyFont}; font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;" target="_blank">📋 SELLERS GUIDE</a>
                                                </td>
                                            </tr>
                                        </table>
                                    </td>
                                    ` : '<td width="50%" style="padding-left: 8px;"></td>'}
                                </tr>
                            </table>
                            ` : ''}
                            <!-- Second Row: Website and Blog -->
                            ${(newsletterData.agent.myWebsiteUrl || newsletterData.agent.blogUrl) ? `
                            <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">
                                <tr>
                                    ${newsletterData.agent.myWebsiteUrl ? `
                                    <td width="50%" style="padding-right: 8px;">
                                        <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">
                                            <tr>
                                                <td style="background-color: #28a745; border-radius: 6px; text-align: center;">
                                                    <a href="${newsletterData.agent.myWebsiteUrl}" style="display: block; padding: 12px 16px; color: white; text-decoration: none; font-family: ${newsletterData.design.bodyFont}; font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;" target="_blank">🌐 MY WEBSITE</a>
                                                </td>
                                            </tr>
                                        </table>
                                    </td>
                                    ` : '<td width="50%" style="padding-right: 8px;"></td>'}
                                    ${newsletterData.agent.blogUrl ? `
                                    <td width="50%" style="padding-left: 8px;">
                                        <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">
                                            <tr>
                                                <td style="background-color: #ff9800; border-radius: 6px; text-align: center;">
                                                    <a href="${newsletterData.agent.blogUrl}" style="display: block; padding: 12px 16px; color: white; text-decoration: none; font-family: ${newsletterData.design.bodyFont}; font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;" target="_blank">✍️ BLOG</a>
                                                </td>
                                            </tr>
                                        </table>
                                    </td>
                                    ` : '<td width="50%" style="padding-left: 8px;"></td>'}
                                </tr>
                            </table>
                            ` : ''}
                        </td>
                    </tr>
                    ` : ''}
                    
                    <!-- Divider -->
                    <tr>
                        <td style="padding: 0 40px;">
                            <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">
                                <tr>
                                    <td style="border-top: 1px solid #e0e0e0; height: 1px; line-height: 1px;">&nbsp;</td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    
                    <!-- Market Statistics -->
                    <tr>
                        <td style="padding: 40px;">
                            ${generateEmailMarketStatsHtml(config)}
                        </td>
                    </tr>
                    
                    <!-- Divider -->
                    <tr>
                        <td style="padding: 0 40px;">
                            <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">
                                <tr>
                                    <td style="border-top: 1px solid #e0e0e0; height: 1px; line-height: 1px;">&nbsp;</td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    
                    <!-- Community Calendar -->
                    <tr>
                        <td style="padding: 40px;">
                            <h2 style="font-family: ${newsletterData.design.headerFont}; font-size: 24px; font-weight: 400; text-align: center; margin: 0 0 30px 0;">Community CALENDAR</h2>
                            ${generateEmailEventsHtml()}
                        </td>
                    </tr>
                    
                    <!-- Divider -->
                    <tr>
                        <td style="padding: 0 40px;">
                            <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">
                                <tr>
                                    <td style="border-top: 1px solid #e0e0e0; height: 1px; line-height: 1px;">&nbsp;</td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    
                    <!-- Maintenance Tips -->
                    <tr>
                        <td style="padding: 40px;">
                            <h2 style="font-family: ${newsletterData.design.headerFont}; font-size: 24px; font-weight: 400; text-align: center; margin: 0 0 30px 0;">${newsletterData.content.newsletterSeason.charAt(0).toUpperCase() + newsletterData.content.newsletterSeason.slice(1)} Maintenance TIPS</h2>
                            <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="background-color: #f9f9f9; border-radius: 8px;">
                                <tr>
                                    <td style="padding: 30px;">
                                        ${getMaintenanceTips(config).map(tip => `
                                            <p style="margin: 0 0 10px 0; padding: 10px 0; border-bottom: 1px solid #e0e0e0; font-family: ${newsletterData.design.bodyFont}; font-size: 14px; color: #666; line-height: 1.4;">${tip}</p>
                                        `).join('')}
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    
                    <!-- Agent Contact -->
                    <tr>
                        <td style="background-color: #f9f9f9; padding: 40px; text-align: center;">
                            ${newsletterData.images.brokerageLogo ? `
                            <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="margin-bottom: 30px;">
                                <tr>
                                    <td align="center">
                                        <img src="${newsletterData.images.brokerageLogo}" alt="Brokerage Logo" style="max-width: 200px; max-height: 80px; height: auto; display: block;" />
                                    </td>
                                </tr>
                            </table>
                            ` : ''}
                            
                            <table role="presentation" cellspacing="0" cellpadding="0" border="0" style="margin: 0 auto;">
                                <tr>
                                    <td valign="middle" style="padding-right: 30px;">
                                        ${newsletterData.images.agentPhoto ? 
                                            `<img src="${newsletterData.images.agentPhoto}" alt="Agent Photo" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; display: block;" />` :
                                            `<div style="width: 100px; height: 100px; border-radius: 50%; background-color: #e0e0e0; display: flex; align-items: center; justify-content: center; color: #999; font-size: 12px;">Agent Photo</div>`
                                        }
                                    </td>
                                    <td valign="middle" style="text-align: left;">
                                        <h3 style="font-family: ${newsletterData.design.headerFont}; font-size: 22px; font-weight: 400; margin: 0 0 5px 0; color: #333;">${newsletterData.agent.name}</h3>
                                        <p style="font-family: ${newsletterData.design.bodyFont}; font-size: 13px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin: 0 0 10px 0;">${newsletterData.agent.company}</p>
                                        <p style="font-family: ${newsletterData.design.bodyFont}; font-size: 14px; margin: 5px 0; color: #333;">📱 ${newsletterData.agent.phone}</p>
                                        <p style="font-family: ${newsletterData.design.bodyFont}; font-size: 14px; margin: 5px 0; color: #333;">✉️ ${newsletterData.agent.email}</p>
                                    </td>
                                    ${newsletterData.images.agentLogo ? `
                                    <td valign="middle" style="padding-left: 20px;">
                                        <img src="${newsletterData.images.agentLogo}" alt="Agent Logo" style="max-width: 120px; max-height: 80px; height: auto; display: block;" />
                                    </td>
                                    ` : ''}
                                </tr>
                            </table>
                            
                            <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="margin-top: 20px;">
                                <tr>
                                    <td align="center">
                                        <a href="http://${newsletterData.agent.website}" style="color: #EA102A; text-decoration: none; font-family: ${newsletterData.design.bodyFont}; font-size: 14px;">${newsletterData.agent.website}</a>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    
                </table>
                
            </td>
        </tr>
    </table>
</body>
</html>`;
            
            return emailTemplate;
        }

        function generateEmailBannerHtml(config) {
            const bannerStyle = newsletterData.design.bannerStyle;
            const headerFont = newsletterData.design.headerFont;
            
            switch (bannerStyle) {
                case 'mountains':
                case 'cityscape':
                case 'blueprint':
                    let imageUrl = '';
                    if (bannerStyle === 'mountains') imageUrl = 'https://i.imgur.com/0dARtuj.png';
                    else if (bannerStyle === 'cityscape') imageUrl = 'https://i.imgur.com/qok5dLZ.png';
                    else if (bannerStyle === 'blueprint') imageUrl = 'https://i.imgur.com/W24OelN.png';
                    
                    return `
                        <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="600" style="margin: 0 auto;">
                            <tr>
                                <td style="background-image: url('${imageUrl}'); background-size: cover; background-position: center; border-radius: 20px; position: relative;" background="${imageUrl}">
                                    <!--[if gte mso 9]>
                                    <v:rect xmlns:v="urn:schemas-microsoft-com:vml" fill="true" stroke="false" style="width:600px;height:300px;">
                                    <v:fill type="tile" src="${imageUrl}" />
                                    <v:textbox inset="0,0,0,0">
                                    <![endif]-->
                                    <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" height="300">
                                        <tr>
                                            <td style="background-color: rgba(0,0,0,0.3); height: 300px;" valign="middle" align="center">
                                                <h1 style="font-family: ${headerFont}; font-size: 42px; font-weight: 400; letter-spacing: 4px; margin: 0; color: white; text-shadow: 0 4px 20px rgba(0,0,0,0.5); text-align: center;">${config.title}</h1>
                                            </td>
                                        </tr>
                                    </table>
                                    <!--[if gte mso 9]>
                                    </v:textbox>
                                    </v:rect>
                                    <![endif]-->
                                </td>
                            </tr>
                        </table>
                    `;
                    
                case 'custom':
                    const customImageUrl = newsletterData.images.customBanner;
                    if (customImageUrl) {
                        return `
                            <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="600" style="margin: 0 auto;">
                                <tr>
                                    <td style="background-image: url('${customImageUrl}'); background-size: cover; background-position: center; border-radius: 20px; position: relative;" background="${customImageUrl}">
                                        <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" height="300">
                                            <tr>
                                                <td style="background-color: rgba(0,0,0,0.3); height: 300px;" valign="middle" align="center">
                                                    <h1 style="font-family: ${headerFont}; font-size: 42px; font-weight: 400; letter-spacing: 4px; margin: 0; color: white; text-shadow: 0 4px 20px rgba(0,0,0,0.7); text-align: center;">${config.title}</h1>
                                                </td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>
                            </table>
                        `;
                    } else {
                        return `
                            <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="600" style="margin: 0 auto;">
                                <tr>
                                    <td style="background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); border-radius: 20px; height: 300px;" valign="middle" align="center">
                                        <h1 style="font-family: ${headerFont}; font-size: 42px; font-weight: 400; letter-spacing: 4px; margin: 0; color: white; text-shadow: 0 4px 20px rgba(0,0,0,0.5); text-align: center;">${config.title}</h1>
                                        <p style="color: white; font-size: 14px; margin: 10px 0 0 0; opacity: 0.9; text-align: center;">Upload custom banner image above</p>
                                    </td>
                                </tr>
                            </table>
                        `;
                    }
                    
                case 'minimal':
                    return `
                        <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="margin: 40px 0;">
                            <tr>
                                <td align="center" style="border-bottom: 2px solid #EA102A; padding-bottom: 10px;">
                                    <h1 style="font-family: ${headerFont}; font-size: 36px; font-weight: 300; letter-spacing: 3px; margin: 0; color: #333;">${config.title}</h1>
                                </td>
                            </tr>
                        </table>
                    `;
                    
                case 'none':
                    return `
                        <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="margin: 40px 0;">
                            <tr>
                                <td align="center">
                                    <h1 style="font-family: ${headerFont}; font-size: 36px; font-weight: 400; letter-spacing: 3px; margin: 0; color: #333;">${config.title}</h1>
                                </td>
                            </tr>
                        </table>
                    `;
                    
                default:
                    return `
                        <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="margin: 40px 0;">
                            <tr>
                                <td align="center">
                                    <h1 style="font-family: ${headerFont}; font-size: 36px; font-weight: 400; letter-spacing: 3px; margin: 0; color: #333;">${config.title}</h1>
                                </td>
                            </tr>
                        </table>
                    `;
            }
        }

        function generateEmailMarketStatsHtml(config) {
            const stats = newsletterData.stats;
            const headerFont = newsletterData.design.headerFont;
            
            // Get previous month name
            const currentMonth = newsletterData.content.newsletterSeason || 'june';
            const monthNames = ['january', 'february', 'march', 'april', 'may', 'june', 'july', 'august', 'september', 'october', 'november', 'december'];
            const currentIndex = monthNames.indexOf(currentMonth);
            const previousIndex = currentIndex === 0 ? 11 : currentIndex - 1;
            const previousMonth = monthNames[previousIndex].charAt(0).toUpperCase() + monthNames[previousIndex].slice(1);
            
            return `
                <h2 style="font-family: ${headerFont}; font-size: 24px; font-weight: 400; text-align: center; margin: 0 0 30px 0;">Snapshot of ${previousMonth} STATISTICS</h2>
                
                <!-- Main Market Indicators - 3 Column Layout -->
                <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="margin-bottom: 30px;">
                    <tr>
                        <td width="33.33%" style="padding: 10px;">
                            <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="background-color: #f9f9f9; border-radius: 8px;">
                                <tr>
                                    <td style="padding: 20px; text-align: center;">
                                        <div style="font-size: 24px; font-weight: 600; color: #EA102A; margin-bottom: 5px;">${stats.avgPrice}</div>
                                        <div style="font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px;">Total Residential Price</div>
                                        <div style="font-size: 14px; font-weight: 500; color: ${stats.priceChange && stats.priceChange.startsWith('-') ? '#dc3545' : '#28a745'};">${stats.priceChange} Y/Y</div>
                                    </td>
                                </tr>
                            </table>
                        </td>
                        <td width="33.33%" style="padding: 10px;">
                            <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="background-color: #f9f9f9; border-radius: 8px;">
                                <tr>
                                    <td style="padding: 20px; text-align: center;">
                                        <div style="font-size: 24px; font-weight: 600; color: #2563eb; margin-bottom: 5px;">${stats.homesSold}</div>
                                        <div style="font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px;">Sales</div>
                                        <div style="font-size: 14px; font-weight: 500; color: ${stats.salesChange && stats.salesChange.startsWith('-') ? '#dc3545' : '#28a745'};">${stats.salesChange || 'N/A'} Y/Y</div>
                                    </td>
                                </tr>
                            </table>
                        </td>
                        <td width="33.33%" style="padding: 10px;">
                            <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="background-color: #f9f9f9; border-radius: 8px;">
                                <tr>
                                    <td style="padding: 20px; text-align: center;">
                                        <div style="font-size: 24px; font-weight: 600; color: #28a745; margin-bottom: 5px;">${stats.newListings}</div>
                                        <div style="font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px;">New Listings</div>
                                        <div style="font-size: 14px; font-weight: 500; color: ${stats.listingsChange && stats.listingsChange.startsWith('-') ? '#dc3545' : '#28a745'};">${stats.listingsChange || 'N/A'} Y/Y</div>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>
                
                <!-- Supply Metrics - 2 Column Layout -->
                <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="margin-bottom: 30px;">
                    <tr>
                        <td width="50%" style="padding: 10px;">
                            <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="background-color: #f9f9f9; border-radius: 8px;">
                                <tr>
                                    <td style="padding: 20px; text-align: center;">
                                        <div style="font-size: 24px; font-weight: 600; color: #ff9800; margin-bottom: 5px;">${stats.inventory}</div>
                                        <div style="font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px;">Total Inventory</div>
                                        <div style="font-size: 14px; font-weight: 500; color: ${stats.inventoryChange && stats.inventoryChange.startsWith('-') ? '#dc3545' : '#28a745'};">${stats.inventoryChange || 'N/A'} Y/Y</div>
                                    </td>
                                </tr>
                            </table>
                        </td>
                        <td width="50%" style="padding: 10px;">
                            <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="background-color: #f9f9f9; border-radius: 8px;">
                                <tr>
                                    <td style="padding: 20px; text-align: center;">
                                        <div style="font-size: 24px; font-weight: 600; color: #6366f1; margin-bottom: 5px;">${stats.monthsOfSupply || stats.daysOnMarket + ' days'}</div>
                                        <div style="font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px;">${stats.monthsOfSupply ? 'Months of Supply' : 'Days on Market'}</div>
                                        <div style="font-size: 14px; font-weight: 500; color: ${stats.supplyChange && stats.supplyChange.startsWith('-') ? '#dc3545' : '#28a745'};">${stats.supplyChange || 'Balanced'}</div>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>
                
                ${(stats.detachedPrice || stats.semiPrice || stats.rowPrice || stats.apartmentPrice) ? generateEmailPropertyAnalysis(stats, headerFont) : ''}
                
                <!-- Market Stats Disclaimer -->
                <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="background-color: #f8f9fa; border-left: 4px solid #17a2b8; border-radius: 6px; margin: 20px 0;">
                    <tr>
                        <td style="padding: 15px;">
                            <div style="font-size: 11px; font-weight: 600; color: #0c5460; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">📊 Disclaimer</div>
                            <p style="font-size: 12px; line-height: 1.4; color: #0c5460; margin: 0; font-family: Arial, sans-serif;">
                                <strong>Disclaimer:</strong> The statistics and market data presented in this report have been provided by the Calgary Real Estate Board (CREB®). While every effort has been made to ensure accuracy, the information is subject to change and should not be considered as financial or investment advice.
                            </p>
                        </td>
                    </tr>
                </table>
                
                ${(newsletterData.content.marketButtonText && newsletterData.content.marketButtonUrl) ? `
                <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="margin-top: 30px;">
                    <tr>
                        <td align="center">
                            <table role="presentation" cellspacing="0" cellpadding="0" border="0">
                                <tr>
                                    <td style="background-color: #EA102A; border-radius: 6px;">
                                        <a href="${newsletterData.content.marketButtonUrl}" style="display: block; padding: 15px 30px; color: white; text-decoration: none; font-family: Arial, sans-serif; font-weight: 600; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;" target="_blank">${newsletterData.content.marketButtonText}</a>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>
                ` : ''}
            `;
        }

        function generateEmailPropertyAnalysis(stats, headerFont) {
            return `
                <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="background-color: #f8f9fa; border-radius: 12px; margin-bottom: 25px;">
                    <tr>
                        <td style="padding: 25px;">
                            <h3 style="font-family: ${headerFont}; font-size: 18px; font-weight: 500; text-align: center; margin: 0 0 25px 0; color: #333;">Property Type Market Analysis</h3>
                            
                            <!-- Property Types - 2x2 Grid -->
                            <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">
                                <tr>
                                    <!-- Detached Homes -->
                                    ${stats.detachedPrice ? `
                                    <td width="50%" style="padding: 10px;">
                                        <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="background-color: white; border-left: 4px solid #EA102A; border-radius: 12px;">
                                            <tr>
                                                <td style="padding: 20px;">
                                                    <div style="font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; font-weight: 600;">🏠 Detached Homes</div>
                                                    <div style="font-size: 22px; font-weight: 700; color: #333; margin-bottom: 8px;">${stats.detachedPrice}</div>
                                                    <div style="font-size: 13px; color: ${stats.detachedChange && stats.detachedChange.startsWith('-') ? '#dc3545' : '#28a745'}; font-weight: 600; margin-bottom: 15px;">${stats.detachedChange || 'N/A'} Y/Y</div>
                                                    
                                                    <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="margin-bottom: 12px;">
                                                        <tr>
                                                            <td width="50%" style="padding: 5px;">
                                                                <div style="background-color: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;">
                                                                    <div style="font-size: 16px; font-weight: 600; color: #EA102A;">${stats.detachedSales || 'N/A'}</div>
                                                                    <div style="font-size: 10px; color: #666; text-transform: uppercase;">Sales</div>
                                                                    ${stats.detachedSalesChange ? `<div style="font-size: 10px; color: ${stats.detachedSalesChange.startsWith('-') ? '#dc3545' : '#28a745'};">${stats.detachedSalesChange}</div>` : ''}
                                                                </div>
                                                            </td>
                                                            <td width="50%" style="padding: 5px;">
                                                                <div style="background-color: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;">
                                                                    <div style="font-size: 16px; font-weight: 600; color: #2563eb;">${stats.detachedListings || 'N/A'}</div>
                                                                    <div style="font-size: 10px; color: #666; text-transform: uppercase;">Listings</div>
                                                                    ${stats.detachedListingsChange ? `<div style="font-size: 10px; color: ${stats.detachedListingsChange.startsWith('-') ? '#dc3545' : '#28a745'};">${stats.detachedListingsChange}</div>` : ''}
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                    
                                                    <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">
                                                        <tr>
                                                            <td width="50%" style="padding: 5px;">
                                                                <div style="background-color: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;">
                                                                    <div style="font-size: 16px; font-weight: 600; color: #28a745;">${stats.detachedInventory || 'N/A'}</div>
                                                                    <div style="font-size: 10px; color: #666; text-transform: uppercase;">Inventory</div>
                                                                </div>
                                                            </td>
                                                            <td width="50%" style="padding: 5px;">
                                                                <div style="background-color: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;">
                                                                    <div style="font-size: 16px; font-weight: 600; color: #ff9800;">${stats.detachedSupply || 'N/A'}</div>
                                                                    <div style="font-size: 10px; color: #666; text-transform: uppercase;">Mos. Supply</div>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </td>
                                            </tr>
                                        </table>
                                    </td>
                                    ` : '<td width="50%" style="padding: 10px;"></td>'}
                                    
                                    <!-- Semi-Detached -->
                                    ${stats.semiPrice ? `
                                    <td width="50%" style="padding: 10px;">
                                        <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="background-color: white; border-left: 4px solid #2563eb; border-radius: 12px;">
                                            <tr>
                                                <td style="padding: 20px;">
                                                    <div style="font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; font-weight: 600;">🏘️ Semi-Detached</div>
                                                    <div style="font-size: 22px; font-weight: 700; color: #333; margin-bottom: 8px;">${stats.semiPrice}</div>
                                                    <div style="font-size: 13px; color: ${stats.semiChange && stats.semiChange.startsWith('-') ? '#dc3545' : '#28a745'}; font-weight: 600; margin-bottom: 15px;">${stats.semiChange || 'N/A'} Y/Y</div>
                                                    
                                                    <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="margin-bottom: 12px;">
                                                        <tr>
                                                            <td width="50%" style="padding: 5px;">
                                                                <div style="background-color: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;">
                                                                    <div style="font-size: 16px; font-weight: 600; color: #EA102A;">${stats.semiSales || 'N/A'}</div>
                                                                    <div style="font-size: 10px; color: #666; text-transform: uppercase;">Sales</div>
                                                                    ${stats.semiSalesChange ? `<div style="font-size: 10px; color: ${stats.semiSalesChange.startsWith('-') ? '#dc3545' : '#28a745'};">${stats.semiSalesChange}</div>` : ''}
                                                                </div>
                                                            </td>
                                                            <td width="50%" style="padding: 5px;">
                                                                <div style="background-color: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;">
                                                                    <div style="font-size: 16px; font-weight: 600; color: #2563eb;">${stats.semiListings || 'N/A'}</div>
                                                                    <div style="font-size: 10px; color: #666; text-transform: uppercase;">Listings</div>
                                                                    ${stats.semiListingsChange ? `<div style="font-size: 10px; color: ${stats.semiListingsChange.startsWith('-') ? '#dc3545' : '#28a745'};">${stats.semiListingsChange}</div>` : ''}
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                    
                                                    <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">
                                                        <tr>
                                                            <td width="50%" style="padding: 5px;">
                                                                <div style="background-color: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;">
                                                                    <div style="font-size: 16px; font-weight: 600; color: #28a745;">${stats.semiInventory || 'N/A'}</div>
                                                                    <div style="font-size: 10px; color: #666; text-transform: uppercase;">Inventory</div>
                                                                </div>
                                                            </td>
                                                            <td width="50%" style="padding: 5px;">
                                                                <div style="background-color: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;">
                                                                    <div style="font-size: 16px; font-weight: 600; color: #ff9800;">${stats.semiSupply || 'N/A'}</div>
                                                                    <div style="font-size: 10px; color: #666; text-transform: uppercase;">Mos. Supply</div>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </td>
                                            </tr>
                                        </table>
                                    </td>
                                    ` : '<td width="50%" style="padding: 10px;"></td>'}
                                </tr>
                                <tr>
                                    <!-- Row/Townhome -->
                                    ${stats.rowPrice ? `
                                    <td width="50%" style="padding: 10px;">
                                        <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="background-color: white; border-left: 4px solid #28a745; border-radius: 12px;">
                                            <tr>
                                                <td style="padding: 20px;">
                                                    <div style="font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; font-weight: 600;">🏘️ Row/Townhome</div>
                                                    <div style="font-size: 22px; font-weight: 700; color: #333; margin-bottom: 8px;">${stats.rowPrice}</div>
                                                    <div style="font-size: 13px; color: ${stats.rowChange && stats.rowChange.startsWith('-') ? '#dc3545' : '#28a745'}; font-weight: 600; margin-bottom: 15px;">${stats.rowChange || 'N/A'} Y/Y</div>
                                                    
                                                    <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="margin-bottom: 12px;">
                                                        <tr>
                                                            <td width="50%" style="padding: 5px;">
                                                                <div style="background-color: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;">
                                                                    <div style="font-size: 16px; font-weight: 600; color: #EA102A;">${stats.rowSales || 'N/A'}</div>
                                                                    <div style="font-size: 10px; color: #666; text-transform: uppercase;">Sales</div>
                                                                    ${stats.rowSalesChange ? `<div style="font-size: 10px; color: ${stats.rowSalesChange.startsWith('-') ? '#dc3545' : '#28a745'};">${stats.rowSalesChange}</div>` : ''}
                                                                </div>
                                                            </td>
                                                            <td width="50%" style="padding: 5px;">
                                                                <div style="background-color: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;">
                                                                    <div style="font-size: 16px; font-weight: 600; color: #2563eb;">${stats.rowListings || 'N/A'}</div>
                                                                    <div style="font-size: 10px; color: #666; text-transform: uppercase;">Listings</div>
                                                                    ${stats.rowListingsChange ? `<div style="font-size: 10px; color: ${stats.rowListingsChange.startsWith('-') ? '#dc3545' : '#28a745'};">${stats.rowListingsChange}</div>` : ''}
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                    
                                                    <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">
                                                        <tr>
                                                            <td width="50%" style="padding: 5px;">
                                                                <div style="background-color: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;">
                                                                    <div style="font-size: 16px; font-weight: 600; color: #28a745;">${stats.rowInventory || 'N/A'}</div>
                                                                    <div style="font-size: 10px; color: #666; text-transform: uppercase;">Inventory</div>
                                                                </div>
                                                            </td>
                                                            <td width="50%" style="padding: 5px;">
                                                                <div style="background-color: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;">
                                                                    <div style="font-size: 16px; font-weight: 600; color: #ff9800;">${stats.rowSupply || 'N/A'}</div>
                                                                    <div style="font-size: 10px; color: #666; text-transform: uppercase;">Mos. Supply</div>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </td>
                                            </tr>
                                        </table>
                                    </td>
                                    ` : '<td width="50%" style="padding: 10px;"></td>'}
                                    
                                    <!-- Apartment/Condo -->
                                    ${stats.apartmentPrice ? `
                                    <td width="50%" style="padding: 10px;">
                                        <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="background-color: white; border-left: 4px solid #ff9800; border-radius: 12px;">
                                            <tr>
                                                <td style="padding: 20px;">
                                                    <div style="font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; font-weight: 600;">🏢 Apartment/Condo</div>
                                                    <div style="font-size: 22px; font-weight: 700; color: #333; margin-bottom: 8px;">${stats.apartmentPrice}</div>
                                                    <div style="font-size: 13px; color: ${stats.apartmentChange && stats.apartmentChange.startsWith('-') ? '#dc3545' : '#28a745'}; font-weight: 600; margin-bottom: 15px;">${stats.apartmentChange || 'N/A'} Y/Y</div>
                                                    
                                                    <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="margin-bottom: 12px;">
                                                        <tr>
                                                            <td width="50%" style="padding: 5px;">
                                                                <div style="background-color: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;">
                                                                    <div style="font-size: 16px; font-weight: 600; color: #EA102A;">${stats.apartmentSales || 'N/A'}</div>
                                                                    <div style="font-size: 10px; color: #666; text-transform: uppercase;">Sales</div>
                                                                    ${stats.apartmentSalesChange ? `<div style="font-size: 10px; color: ${stats.apartmentSalesChange.startsWith('-') ? '#dc3545' : '#28a745'};">${stats.apartmentSalesChange}</div>` : ''}
                                                                </div>
                                                            </td>
                                                            <td width="50%" style="padding: 5px;">
                                                                <div style="background-color: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;">
                                                                    <div style="font-size: 16px; font-weight: 600; color: #2563eb;">${stats.apartmentListings || 'N/A'}</div>
                                                                    <div style="font-size: 10px; color: #666; text-transform: uppercase;">Listings</div>
                                                                    ${stats.apartmentListingsChange ? `<div style="font-size: 10px; color: ${stats.apartmentListingsChange.startsWith('-') ? '#dc3545' : '#28a745'};">${stats.apartmentListingsChange}</div>` : ''}
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                    
                                                    <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">
                                                        <tr>
                                                            <td width="50%" style="padding: 5px;">
                                                                <div style="background-color: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;">
                                                                    <div style="font-size: 16px; font-weight: 600; color: #28a745;">${stats.apartmentInventory || 'N/A'}</div>
                                                                    <div style="font-size: 10px; color: #666; text-transform: uppercase;">Inventory</div>
                                                                </div>
                                                            </td>
                                                            <td width="50%" style="padding: 5px;">
                                                                <div style="background-color: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;">
                                                                    <div style="font-size: 16px; font-weight: 600; color: #ff9800;">${stats.apartmentSupply || 'N/A'}</div>
                                                                    <div style="font-size: 10px; color: #666; text-transform: uppercase;">Mos. Supply</div>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </td>
                                            </tr>
                                        </table>
                                    </td>
                                    ` : '<td width="50%" style="padding: 10px;"></td>'}
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>
            `;
        }

        function generateEmailEventsHtml() {
            if (!newsletterData.customEvents || newsletterData.customEvents.length === 0) {
                return `
                    <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">
                        <tr>
                            <td style="text-align: center; padding: 40px 20px; color: #999; font-style: italic;">
                                <div style="font-size: 48px; margin-bottom: 15px;">📅</div>
                                <p style="font-size: 16px; margin: 0;">No events added yet</p>
                                <p style="font-size: 14px; margin: 5px 0 0 0;">Click "Add Event" to create your community calendar</p>
                            </td>
                        </tr>
                    </table>
                `;
            }
            
            // Sort events by date before displaying
            const sortedEvents = newsletterData.customEvents
                .sort((a, b) => new Date(a.date) - new Date(b.date));
            
            return sortedEvents.map(event => `
                <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="margin-bottom: 20px; border: 1px solid #f0f0f0; border-radius: 8px; background-color: #fafafa;">
                    <tr>
                        <td style="padding: 20px;">
                            <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">
                                <tr>
                                    <td width="100" style="text-align: center; vertical-align: top; padding-right: 20px;">
                                        <div style="background-color: #EA102A; color: white; padding: 8px; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; border-radius: 4px;">${formatEventDate(event.date).month}</div>
                                        <div style="font-size: 24px; font-weight: 300; color: #333;">${formatEventDate(event.date).day}</div>
                                        ${event.startTime ? `<div style="font-size: 10px; color: #666; margin-top: 5px; line-height: 1.2;">${formatEventTime(event.startTime, event.endTime)}</div>` : ''}
                                    </td>
                                    <td ${event.image ? 'style="padding-right: 20px; vertical-align: top;"' : 'style="vertical-align: top;"'}>
                                        <h3 style="font-size: 16px; font-weight: 500; margin: 0 0 5px 0; color: #333;">${event.title}</h3>
                                        ${event.startTime ? `<p style="font-size: 13px; color: #666; margin: 0 0 5px 0;">🕐 ${formatEventTime(event.startTime, event.endTime)}</p>` : ''}
                                        ${event.location ? `<p style="font-size: 13px; color: #666; margin: 0 0 5px 0;">📍 ${event.location}</p>` : ''}
                                        ${event.description ? `<p style="font-size: 12px; color: #999; margin: 5px 0 0 0; font-style: italic; line-height: 1.4;">${event.description}</p>` : ''}
                                        ${event.detailsLink ? `
                                        <table role="presentation" cellspacing="0" cellpadding="0" border="0" style="margin-top: 15px;">
                                            <tr>
                                                <td style="background-color: #EA102A; border-radius: 5px;">
                                                    <a href="${event.detailsLink}" style="display: block; padding: 8px 16px; color: white; text-decoration: none; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;" target="_blank">📋 EVENT DETAILS</a>
                                                </td>
                                            </tr>
                                        </table>
                                        ` : ''}
                                    </td>
                                    ${event.image ? `
                                    <td width="150" style="text-align: center; vertical-align: top;">
                                        <img src="${event.image}" alt="Event Image" style="width: 140px; height: 100px; object-fit: cover; border-radius: 6px; border: 2px solid #e0e0e0; display: block;" />
                                    </td>
                                    ` : ''}
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>
            `).join('');
        }

        // Update events list in sidebar
        function updateEventsList() {
            const container = document.getElementById('customEventsList');
            
            if (!newsletterData.customEvents || newsletterData.customEvents.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #999; font-style: italic; font-size: 14px;">
                        No events added yet
                    </div>
                `;
                return;
            }
            
            // Sort events by date before displaying
            const sortedEvents = newsletterData.customEvents
                .sort((a, b) => new Date(a.date) - new Date(b.date));
            
            container.innerHTML = sortedEvents.map(event => `
                <div class="event-item" style="margin-top: 10px;">
                    <button class="event-delete" onclick="deleteEvent('${event.id}')" title="Delete event">×</button>
                    <div style="display: flex; gap: 15px; align-items: flex-start;">
                        ${event.image ? `
                        <div style="flex-shrink: 0;">
                            <img src="${event.image}" style="width: 60px; height: 45px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd;" alt="Event">
                        </div>
                        ` : ''}
                        <div style="flex: 1; min-width: 0;">
                            <h4 style="font-size: 14px; font-weight: 600; margin: 0 0 5px 0; color: #333;">
                                ${event.title}
                                ${event.detailsLink ? '<span style="color: #EA102A; font-size: 12px; margin-left: 5px;">🔗</span>' : ''}
                            </h4>
                            <p style="font-size: 12px; color: #666; margin: 0 0 3px 0;">📅 ${formatEventDate(event.date).month} ${formatEventDate(event.date).day}${event.startTime ? ` • ${formatEventTime(event.startTime, event.endTime)}` : ''}</p>
                            ${event.location ? `<p style="font-size: 12px; color: #666; margin: 0;">📍 ${event.location}</p>` : ''}
                            ${event.description ? `<p style="font-size: 11px; color: #999; margin: 5px 0 0 0; font-style: italic;">${event.description.length > 60 ? event.description.substring(0, 60) + '...' : event.description}</p>` : ''}
                            ${event.detailsLink ? `<p style="font-size: 11px; color: #EA102A; margin: 3px 0 0 0;">🔗 Details link available</p>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Delete event function
        function deleteEvent(eventId) {
            if (confirm('Are you sure you want to delete this event?')) {
                newsletterData.customEvents = newsletterData.customEvents.filter(event => event.id !== eventId);
                updateEventsList();
                updatePreview();
                showToast('✅ Event deleted successfully', 'success');
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Text inputs
            ['agentName', 'companyName', 'agentPhone', 'agentEmail', 'agentWebsite', 'buyersGuideUrl', 'sellersGuideUrl', 'myWebsiteUrl', 'blogUrl', 'personalMessage', 'customSubtitle', 'customMaintenanceTips', 'marketButtonText', 'marketButtonUrl'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', (e) => handleFormChange(id, e.target.value));
                }
            });

            // Select inputs
            ['bannerStyle', 'headerFont', 'bodyFont', 'newsletterSeason'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', (e) => handleFormChange(id, e.target.value));
                }
            });

            // Add event form
            const addEventForm = document.getElementById('addEventForm');
            if (addEventForm) {
                addEventForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    
                    const title = document.getElementById('eventTitle').value.trim();
                    const date = document.getElementById('eventDate').value;
                    const startTime = document.getElementById('eventStartTime').value;
                    const endTime = document.getElementById('eventEndTime').value;
                    const location = document.getElementById('eventLocation').value.trim();
                    const description = document.getElementById('eventDescription').value.trim();
                    const detailsLink = document.getElementById('eventDetailsLink').value.trim();
                    
                    if (!title || !date) {
                        showToast('❌ Please fill in Title and Date (required fields)', 'error');
                        return;
                    }
                    
                    // Validate URL if provided
                    if (detailsLink && !detailsLink.startsWith('http://') && !detailsLink.startsWith('https://')) {
                        showToast('❌ Event details link must start with http:// or https://', 'error');
                        return;
                    }
                    
                    // Validate end time is after start time (only if both are provided)
                    if (startTime && endTime && endTime <= startTime) {
                        showToast('❌ End time must be after start time', 'error');
                        return;
                    }
                    
                    if (!newsletterData.customEvents) {
                        newsletterData.customEvents = [];
                    }
                    
                    const newEvent = {
                        id: Date.now().toString(),
                        title,
                        date,
                        startTime,
                        endTime,
                        location,
                        description,
                        detailsLink,
                        image: newsletterData.images.currentEventImage
                    };
                    
                    newsletterData.customEvents.push(newEvent);
                    
                    // Reset the current event image
                    newsletterData.images.currentEventImage = null;
                    
                    showToast('✅ Event added successfully!', 'success');
                    modalManager.close('addEventModal');
                    updateEventsList();
                    updatePreview();
                });
            }

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    generateNewsletter();
                }
            });
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            try {
                renderStats();
                setupEventListeners();
                updateMonthDisplay();
                updateEventsList();
                updatePreview();
                
                showToast('🚀 Newsletter Builder Pro Enhanced ready!', 'success', 4000);
                
                console.log('💡 Newsletter Builder Pro Enhanced - Tips:');
                console.log('• Use Ctrl/Cmd + Enter to generate newsletter');
                console.log('• Print button optimized for professional paper output');
                
            } catch (error) {
                console.error('Application initialization error:', error);
                showToast('⚠️ Application started with some limitations. Please refresh if you encounter issues.', 'warning', 6000);
            }
        });
    </script>
</body>
</html>